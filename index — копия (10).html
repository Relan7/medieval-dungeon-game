<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤–æ–µ –ü–æ–¥–∑–µ–º–µ–ª—å–µ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
body, html {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background: url('background.png') no-repeat center center fixed;
    background-size: cover;
}

        canvas {
            display: block;
            background: #000;
        }
        .crosshair {
            position: absolute;
            width: 60px;
            height: 60px;
            background: url('crosshair.png') no-repeat center;
            background-size: contain;
            pointer-events: none;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease-in-out;
            display: none;
        }
        #bottomMenu {
            position: fixed;
            bottom: 0;
            left: 210px;
            width: 100%;
            height: 60px;
            background: #333;
            color: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 18px;
        }
        #characterMenu {
    position: fixed;
    top: 0px;
    right: 10px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    display: block; 
    font-size: 16px;
    text-align: center;
    max-width: calc(100vw - 20px); 
    max-height: calc(100vh - 120px); 
    overflow: auto; 
}

#leftCharacterMenu {
        position: fixed;
        top: 0px;
        left: 0px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        display: block;
        font-size: 16px;
        text-align: center;
        max-width: calc(100vw - 20px);
        max-height: calc(100vh - 20px);
        overflow: auto;
        display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    }
        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ */
        #fullscreenButton {
            position: fixed;
            bottom: 60px;
            right: 0px;
            padding: 10px 20px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            z-index: 1000;
        }



        #shopMenu {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        #shopItems {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .shop-item {
            margin: 10px;
            text-align: center;
            cursor: pointer;
        }
        .shop-item img {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            transition: transform 0.3s;
        }
        .shop-item img:hover {
            transform: scale(1.1);
        }
        #itemDetail {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
        #itemDetail img {
            max-width: 100%;
            max-height: 80vh;
        }
        #itemDetail button {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: none;
            cursor: pointer;
        }
        .status-bar {
            position: fixed;
            top: 10px;
            left: 300px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
        }
        .status-bar p {
            margin: 8px 0;
            font-size: 18px; /* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
        }
        .health-bar {
            background: #555;
            border-radius: 5px;
            overflow: hidden;
            width: 200px;
            height: 20px;
            margin-bottom: 10px;
        }
        .health-bar-inner {
            height: 100%;
            background: #0f0;
        }
        .monster-health-bar-inner {
            height: 100%;
            background: #f00; /* Red for monster health */
        }
        .victory-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            display: none;
            z-index: 2001;
        }
        .hero img {
        width: 175px;
        height: 242px;
        border-radius: 10px;
        transition: filter 0.3s;
    }

    .hero.not-hired img {
        filter: brightness(10%);
    }

    .hero.hired img {
        filter: brightness(100%);
    }
        #characterImage {
            width: 297px;
            height: 500px;
        }
        #nicknameMenu {
            display: block;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #topPlayersMenu {
            display: none;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #gameVersion {
            position: absolute;
            bottom: 10px;
            right: 10px;
            color: white;
            font-size: 12px;
        }
        #continuePrompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        #continuePrompt button {
            margin: 5px;
            padding: 10px;
            background: #fff;
            border: none;
            cursor: pointer;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fff;
            border: none;
            padding: 5px;
            cursor: pointer;
        }
        .monster-message {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
            display: none;
        }
        #weaponInfo, #healthInfo {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Ä—É–∂–∏—è –∏ –∑–¥–æ—Ä–æ–≤—å—è */
        }

        #mailButton {
            position: fixed;
            top: 190px;
            left: 300px;
            width: 150px;
            height: 150px;
            background: url('mail.png') no-repeat center;
            background-size: cover;
            cursor: pointer;
            transition: transform 0.3s;
            display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
        #mailButton:hover {
            transform: scale(1.1);
        }
        #mailWindow {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 400px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
        }
        #rebornButton {
    position: fixed;
    top: 5px;
    right: 325px;
    width: 200px;
    height: 200px;
    background: url('reborn.png') no-repeat center;
    background-size: contain;
    cursor: pointer;
    z-index: 1000;
    transition: transform 0.3s, box-shadow 0.3s;
}
#rebornButton:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(255, 255, 0, 0.8); /* –î–æ–±–∞–≤—å—Ç–µ –∫—Ä–∞—Å–∏–≤—É—é —Ç–µ–Ω—å */
}
#rebornPrompt {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    z-index: 2000;
}

#rebornPrompt button {
    margin: 10px;
    padding: 10px;
    background: #fff;
    border: none;
    cursor: pointer;
}
#monsterHealthContainer {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 30%; /* –®–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    height: 50px; /* –í—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    background-color: rgba(255, 0, 0, 0.2); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    border-radius: 15px;
    overflow: hidden; /* –û–±—Ä–µ–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
    display: none; /* –°–∫—Ä—ã—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}

#monsterHealthBar {
    height: 100%; /* –í—ã—Å–æ—Ç–∞ –ø–æ–ª–æ—Å–∫–∏ —Ä–∞–≤–Ω–∞ –≤—ã—Å–æ—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    background-color: green; /* –¶–≤–µ—Ç –ø–æ–ª–æ—Å–∫–∏ */
    border-radius: 15px; /* –û–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
    transition: width 0.5s; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —à–∏—Ä–∏–Ω—ã */
}

#monsterHealthValue {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 32px;
    line-height: 50px; /* –í—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤—ã—Å–æ—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); /* –¢–µ–Ω—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
    font-weight: bold; /* –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
    padding: 0 10px; /* –û—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º */
    border: 2px solid rgba(0, 0, 0, 0.5); /* –û–±–≤–æ–¥–∫–∞ –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—Å—Ç–∞ */
    border-radius: 5px; /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
    background-color: rgba(0, 0, 0, 0.3); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
}

#chatContainer {
    position: fixed;
    bottom: 60px;
    left: 210px;
    width: 300px;
    max-height: 400px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 5px;
    overflow: auto;
    display: flex;
    flex-direction: column;
    padding: 10px;
    display: none; /* –°–∫—Ä—ã—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}

#chatMessages {
    flex-grow: 1;
    overflow-y: auto;
}

#chatInput {
    display: flex;
    margin-top: 10px;
}

#chatInput input {
    flex-grow: 1;
    padding: 5px;
    border: none;
    border-radius: 3px;
}

#chatInput button {
    margin-left: 5px;
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    background-color: #333;
    color: white;
    cursor: pointer;
}
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
button.upgrade-button, button.hire-button {
    background: linear-gradient(to right, #ff416c, #ff4b2b); /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω */
    border: none;
    border-radius: 10px; /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
    color: white;
    cursor: pointer;
    font-size: 18px; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
    padding: 10px 20px;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4); /* –¢–µ–Ω—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
}

/* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É */
button.upgrade-button:hover, button.hire-button:hover {
    transform: scale(1.05); /* –õ–µ–≥–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
    box-shadow: 0 6px 20px rgba(255, 75, 43, 0.6); /* –ë–æ–ª–µ–µ —è—Ä–∫–∞—è —Ç–µ–Ω—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
}
#toggleAutoboyButton {
    position: fixed;
    bottom: 100px; /* –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π "–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º" */
    right: 0px;
    padding: 10px 20px;
    background: #333;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 16px;
    z-index: 1000;
    display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}
#pvpButton {
            position: fixed;
            bottom: 210px;
            left: 790px;
            width: 200px;
            height: 200px;
            background: url('Sworddouble.png') no-repeat center;
            background-size: contain;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        #pvpButton:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ PvP */
        #pvpRegistration {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
        }

        #pvpRegistration button {
            margin: 10px;
            padding: 10px;
            background: #fff;
            border: none;
            cursor: pointer;
        }
        #pvpBattle {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
        }
        #pvpBattle button {
            margin: 10px;
            padding: 10px;
            background: #fff;
            border: none;
            cursor: pointer;
        }
        #clanListMenu, #clanMenu {
  display: none; 
  position: fixed; 
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 20px;
  border-radius: 5px; 
  z-index: 1001; /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–µ–Ω—é –≤—ã—à–µ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
}

#clanDonateMenu {
  display: none;
  position: fixed;
  top: 25%;
  left: 50%;
  transform: translate(-50%, -50%); 
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 20px;
  border-radius: 5px;
  z-index: 1003;
}
#rebornMenu  {
  display:  none; 
  position:  fixed; 
  top:  50%;
  left:  50%;
  transform:  translate(-50%,  -50%); 
  background:  rgba(0,  0,  0,  0.8);
  color:  white; 
  padding:  20px;
  border-radius:  5px;
  z-index:  1001;  
}
#errorMessage {
    display: none;
    position: fixed; 
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8); 
    color: white;
    padding: 20px; 
    border-radius: 5px;
    z-index: 1001; 
}
#rebornSuccessMessage  {
    /*  –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ  —Ç–µ  –∂–µ  —Å—Ç–∏–ª–∏,  —á—Ç–æ  –∏  –¥–ª—è  rebornMenu  –∏  errorMessage */
    display: none; 
    position: fixed; 
    top: 50%;
    left: 50%; 
    transform: translate(-50%,  -50%);
    background: rgba(0, 0, 0, 0.8); 
    color: white; 
    padding: 20px;
    border-radius: 5px;
    z-index: 1001;
}
#gameMessage  {
  display:  none;
  position:  fixed;
  top:  50%; 
  left:  50%;
  transform:  translate(-50%,  -50%); 
  background:  rgba(0,  0,  0,  0.8);
  color:  rgb(240, 9, 9);
  padding:  20px; 
  border-radius:  5px; 
  z-index:  9999; 
  text-align:  center; /*  –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º  —Ç–µ–∫—Å—Ç */ 
  font-weight:  bold; /*  –î–µ–ª–∞–µ–º  —Ç–µ–∫—Å—Ç  –∂–∏—Ä–Ω—ã–º  */
}
#arenaScreen  {
    display:  none;
    position:  fixed;
    top:  50%;
    left:  50%;
    transform:  translate(-50%,  -50%);
    background:  rgba(0,  0,  0,  0.8); 
    color:  white; 
    padding:  20px; 
    border-radius:  5px; 
    z-index:  1001;
    text-align: center;
} 
#pvpLastBattles {
  list-style-type: none;
  padding: 0;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 3002;
  font-size: 18px;
}

#pvpLastBattles li {
  margin-bottom: 5px;
  text-align: left;
  color: white; 
  text-shadow: 
    -1px -1px 0 #000, 
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;  /*  –ß–µ—Ä–Ω–∞—è  –æ–±–≤–æ–¥–∫–∞ */
}

/*  –¶–≤–µ—Ç–Ω—ã–µ  –æ–±–≤–æ–¥–∫–∏  –¥–ª—è  –∫–∞–∂–¥–æ–π  –±–∏—Ç–≤—ã  */ 
#pvpLastBattles  li:nth-child(1) {
  text-shadow: 
    -1px -1px 0 red, 
    1px -1px 0 red, 
    -1px 1px 0 red,
    1px 1px 0 red;
}

#pvpLastBattles  li:nth-child(2)  { 
  text-shadow:
    -1px -1px 0  blue,
    1px  -1px 0  blue, 
    -1px 1px  0  blue,
    1px 1px  0  blue;
}

#pvpLastBattles  li:nth-child(3)  {
  text-shadow: 
    -1px -1px 0  green, 
    1px  -1px 0  green, 
    -1px 1px 0  green,
    1px 1px  0  green;
}

#dailyQuestsMenu {
    display: none;
    position:  fixed;
    top: 50%;
    left: 50%; 
    transform:  translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8); 
    color: white; 
    padding:  20px;
    border-radius: 5px;
    z-index: 1001;
    text-align:  center; 
    font-size:  16px;  /*  –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞  */ 
}

#dailyQuestsList {
    list-style-type:  none;  
    padding: 0;
    text-align:  left;  
    max-height:  300px; /*   –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É  —Å–ø–∏—Å–∫–∞ */ 
    overflow-y:  auto;  /*  –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */ 
}

#dailyQuestsList  li {
    margin-bottom: 5px; 
    /*  –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–Ω  –∏  —Ä–∞–º–∫—É  –¥–ª—è  –ª—É—á—à–µ–π  —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */ 
    background-color: rgba(0, 0, 0, 0.5);  
    border: 1px solid white;  
    padding:  8px;  /*  –î–æ–±–∞–≤–ª—è–µ–º  –æ—Ç—Å—Ç—É–ø—ã  */
}

#dailyQuestResetTime {
    margin-top: 10px; 
    font-size: 14px;
    text-align:  center;  
}
#dailyQuestsButton {
    position:  fixed; 
    top: 500px;
    right: 300px; 
    width:  50px;
    height:  50px;
    cursor: pointer; 
}

#dailyQuestsButton img  {
    width: 100%;
    height: 100%;
}
    </style>
</head>
<body>

    <!--  –†–∞–∑–¥–µ–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π  --> 
<div  id="dailyQuestsMenu"  style="display:  none;">
    <h2>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
    <ul  id="dailyQuestsList"></ul>
    <button  onclick="closeDailyQuestsMenu()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
<!-- –ö–Ω–æ–ø–∫–∞  –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö  –∑–∞–¥–∞–Ω–∏–π --> 
<div  id="dailyQuestsButton"  onclick="openDailyQuestsMenu()"> 
    <img  src="daily_quest_icon.png" alt="Daily Quests"> 
</div>

    <div  id="gameMessage"  style="display:  none;">
        <p  id="gameMessageText"></p>
    </div>
    <div id="arenaScreen" style="display:none;">
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ PvP-–±–∏—Ç–≤—ã</h3> 
    </div>
    
    <ul  id="pvpLastBattles"></ul>  <!--  –ü–µ—Ä–µ–º–µ—â–∞–µ–º  —Å–ø–∏—Å–æ–∫  —Å—é–¥–∞ -->
    <div id="clanDonateMenu" style="display: none;"> 
        <h3>–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ –≤ –∫–ª–∞–Ω</h3>
        <p>–¢—Ä–µ–±—É–µ—Ç—Å—è: <span id="clanUpgradeCost"></span> –∑–æ–ª–æ—Ç–∞</p> 
        <p>–°–æ–±—Ä–∞–Ω–æ: <span id="clanCurrentDonations"></span> –∑–æ–ª–æ—Ç–∞</p> 
        <input type="number" id="clanDonateAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="1">
        <button onclick="donateToClan()">–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å</button> 
        <button onclick="closeClanDonateMenu()">–ó–∞–∫—Ä—ã—Ç—å</button> 
    </div>

    <div id="clanMenu">
        <h2><span id="clanName"></span> (<span id="clanLevel"></span> —É—Ä–æ–≤–µ–Ω—å)</h2>
        <p>–õ–∏–¥–µ—Ä: <span id="clanLeader"></span></p>
        <ul id="clanMembers"></ul>
        <button onclick="leaveClan()">–ü–æ–∫–∏–Ω—É—Ç—å –∫–ª–∞–Ω</button>
        <button onclick="upgradeClan()">–£–ª—É—á—à–∏—Ç—å –∫–ª–∞–Ω</button>
        <button onclick="openClanDonateMenu()">–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å</button> <button onclick="closeClanMenu()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="rebornMenu" style="display:  none;">
        <h2>–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ</h2> 
        <p id="rebornMessage"></p>
        <button onclick="confirmReborn()">–ü–µ—Ä–µ—Ä–æ–¥–∏—Ç—å—Å—è</button>
        <button onclick="closeRebornMenu()">–û—Ç–º–µ–Ω–∞</button>
    </div>


    <button id="fullscreenButton" onclick="toggleFullscreen()">–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º</button>
    <button id="toggleAutoboyButton" onclick="toggleAutoboy()">–û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–±–æ–π</button>
    <div id="pvpButton" onclick="openPvpRegistration()"></div>
    <div id="nicknameMenu">
        <h2>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º</h2>
        <input type="text" id="nicknameInput" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
        <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        <div id="gameVersion">–í–µ—Ä—Å–∏—è –∏–≥—Ä—ã: 1.15</div>
    </div>
    <canvas id="gameCanvas" style="display:none;"></canvas>
    <div id="bottomMenu" style="display:none;">
        <div onclick="changeScreen('arena')">–ê—Ä–µ–Ω–∞</div>
        <div onclick="changeScreen('dungeon')">–ü–æ–¥–∑–µ–º–µ–ª—å–µ</div>
        <div onclick="changeScreen('raid')">–†–µ–π–¥</div>
        <div onclick="changeScreen('castle')">–ó–∞–º–æ–∫</div>
        <div onclick="openClanListMenu()">–ö–ª–∞–Ω—ã</div>
        <div onclick="changeScreen('worldBoss')">–ú–∏—Ä–æ–≤–æ–π –ë–æ—Å—Å</div>
        <div onclick="toggleShop()">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div onclick="toggleTopPlayers()">–¢–æ–ø –∏–≥—Ä–æ–∫–∏</div>
       
    </div>

    <div id="chatContainer"> 
        <button onclick="switchChat('global')">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</button>
        <button onclick="switchChat('clan')">–ö–ª–∞–Ω–æ–≤—ã–π —á–∞—Ç</button> 
        <div id="chatMessages"></div> 
        <div id="chatInput">
            <input type="text" id="chatMessageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="pvpRegistration">
        <h2>–•–æ—Ç–∏—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –±–æ–π PvP?</h2>
        <button>–î–∞</button> <button onclick="closePvpRegistration()">–ù–µ—Ç</button> 
      </div>
    <div id="pvpBattle" style="display:none;">
        <h2>–ë–æ–π PvP</h2>
        <div id="pvpOpponentInfo"></div>
        <div id="pvpFightLog"></div>
        <button onclick="endPvpBattle()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π</button>
    </div>

    <div id="monsterHealthContainer">
        <div id="monsterHealthBar"></div>
        <div id="monsterHealthValue"></div>
    </div>
    <div id="monsterHealthDisplay">
        <span style="font-size: 30px; margin-right: 10px;">‚ù§Ô∏è</span>
        –ó–¥–æ—Ä–æ–≤—å–µ –º–æ–Ω—Å—Ç—Ä–∞ <span id="monsterHealthValue"></span>
    </div>
    

    


    <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø–∏—Å—å–º–∞ -->
    <div id="mailButton" onclick="toggleMailWindow()"></div>

    <!-- –û–∫–Ω–æ –ø–æ—á—Ç—ã -->
    <div id="mailWindow">
        <h2>–í–∞—à–∞ –ø–æ—á—Ç–∞</h2>
        <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à–∏ –Ω–∞–≥—Ä–∞–¥—ã.</p>
        <button onclick="toggleMailWindow()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="rebornButton" onclick="showRebornPrompt()"></div>
    <div id="rebornPrompt">
        <h2>–í—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ—Ä–æ–¥–∏—Ç—å—Å—è?</h2>
        <p>–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω–µ–π, –Ω–∞–Ω—è—Ç—ã–µ –≥–µ—Ä–æ–∏ –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–µ –∑–æ–ª–æ—Ç–æ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã. –ù–æ –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ —É–±–∏–π—Å—Ç–≤–æ –º–æ–Ω—Å—Ç—Ä–æ–≤ –≤ –¥–≤–∞ —Ä–∞–∑–∞ –≤—ã—à–µ.</p>
        <button onclick="confirmReborn()">–î–∞</button>
        <button onclick="hideRebornPrompt()">–ù–µ—Ç</button>
    </div>

    <!-- –ú–µ–Ω—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–ª–∞–Ω–æ–≤ -->
<div id="clanListMenu">
    <h2>–°–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–æ–≤</h2>
    <ul id="clanList"></ul>
    <input type="text" id="clanNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞">
    <button onclick="createClan(document.getElementById('clanNameInput').value)">–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω</button>
    <button onclick="closeClanListMenu()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>



    <div id="worldBossScreen" style="display:none;">
        <h2>–ú–∏—Ä–æ–≤–æ–π –ë–æ—Å—Å</h2>
        <img id="worldBossImage" src="world_boss.png" alt="–ú–∏—Ä–æ–≤–æ–π –ë–æ—Å—Å">
        <div id="worldBossHealth">–ó–¥–æ—Ä–æ–≤—å–µ –ë–æ—Å—Å–∞: <span id="worldBossHealthValue">1000000</span></div>
        <div id="playersDamageList">
            <h3>–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</h3>
            <ul id="damageList"></ul>
        </div>
    </div>
   
    <div id="leftCharacterMenu">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–µ–Ω—é –¥–ª—è –Ω–∞–π–º–∞ –≥–µ—Ä–æ–µ–≤ —Å–ª–µ–≤–∞ –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
    </div>
    
    </div>
    <div id="characterMenu">
        <img id="characterImage" src="peasant.png" alt="Character">
        <p style="display:none;">–û—Ä—É–∂–∏–µ: <span id="weapon"></span></p> <!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ä—É–∂–∏—è -->
        <p style="display:none;">–ó–¥–æ—Ä–æ–≤—å–µ: <span id="health"></span></p> <!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è -->
        <p style="display:none;">–£—Ä–æ–≤–µ–Ω—å: <span id="level"></span></p>
        <p style="display:none;">–ó–æ–ª–æ—Ç–æ: <span id="gold"></span></p>
        <p style="display:none;"><span id="totalDamage">–°—É–º–º–∞—Ä–Ω—ã–π —É—Ä–æ–Ω: 0</p>

        <p style="display:none;">–£—Ä–æ–Ω: <span id="damage"></span></p>
        
        
        
    </div>
    <div id="shopMenu">
        <button class="close-btn" onclick="toggleShop()">X</button>
        <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
        <p>–ó–æ–ª–æ—Ç–æ: <span id="shopGold"></span></p>
        <div id="shopItems">
            <div class="shop-item" onclick="showItemDetail('sword.png', '–ú–µ—á (+10 —Å–∏–ª–∞)', 50, 'sword', 10)">
                <img src="sword_thumb.png" alt="–ú–µ—á">
                <p>–ú–µ—á</p>
                <p>50 –∑–æ–ª–æ—Ç–∞</p>
            </div>
            <div class="shop-item" onclick="showItemDetail('bow.png', '–õ—É–∫ (+8 —Å–∏–ª–∞)', 40, 'bow', 8)">
                <img src="bow_thumb.png" alt="–õ—É–∫">
                <p>–õ—É–∫</p>
                <p>40 –∑–æ–ª–æ—Ç–∞</p>
            </div>
            <div class="shop-item" onclick="showItemDetail('crossbow.png', '–ê—Ä–±–∞–ª–µ—Ç (+12 —Å–∏–ª–∞)', 60, 'crossbow', 12)">
                <img src="crossbow_thumb.png" alt="–ê—Ä–±–∞–ª–µ—Ç">
                <p>–ê—Ä–±–∞–ª–µ—Ç</p>
                <p>60 –∑–æ–ª–æ—Ç–∞</p>
            </div>
            <div class="shop-item" onclick="showItemDetail('armor.png', '–î–æ—Å–ø–µ—Ö–∏ (+15 –∑–∞—â–∏—Ç–∞)', 70, 'armor', 15)">
                <img src="armor_thumb.png" alt="–î–æ—Å–ø–µ—Ö–∏">
                <p>–î–æ—Å–ø–µ—Ö–∏</p>
                <p>70 –∑–æ–ª–æ—Ç–∞</p>
            </div>
            <div class="shop-item" onclick="showItemDetail('helmet.png', '–®–ª–µ–º (+5 –∑–∞—â–∏—Ç–∞)', 30, 'helmet', 5)">
                <img src="helmet_thumb.png" alt="–®–ª–µ–º">
                <p>–®–ª–µ–º</p>
                <p>30 –∑–æ–ª–æ—Ç–∞</p>
            </div>
            
        </div>
    </div>
    <div id="topPlayersMenu">
        <button onclick="toggleTopPlayers()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="status-bar" id="statusBar" style="display:none;">
        <div class="health-bar">
            <div class="health-bar-inner" id="playerHealthBar"></div>
        </div>
        <p>–£—Ä–æ–≤–µ–Ω—å: <span id="statusLevel"></span></p>
        <p> <img src="gold_icon.png" alt="Gold Icon" style="width: 30px; height: 30px; vertical-align: middle;"> <span id="statusGold"></span></p>
        <p> <img src="damage_icon.png" alt="Gold Icon" style="width: 30px; height: 30px; vertical-align: middle;"> <span id="statusDamage"></span></p>
        <p>–ú–Ω–æ–∂–∏—Ç–µ–ª—å –Ω–∞–≥—Ä–∞–¥—ã: <span id="statusRewardMultiplier"></span></p> <!-- –ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª—è –Ω–∞–≥—Ä–∞–¥—ã -->
    </div>
    
    <div id="errorMessage" style="display: none;">
        <p id="errorMessageText"></p>
        <button onclick="closeErrorMessage()">–ó–∞–∫—Ä—ã—Ç—å</button> 
    </div>


    
    <div class="victory-message" id="victoryMessage">
        <p>Shap –≤ –ø–µ—á–∞–ª–∏, —á—Ç–æ –≤—ã –µ–≥–æ –±—å–µ—Ç–µ :(</p>
    </div>
    
    <div id="rebornSuccessMessage" style="display:  none;">
        <p id="rebornSuccessMessageText"></p>
        <button onclick="closeRebornSuccessMessage()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    
    <div class="crosshair" id="crosshair"></div>
    <div id="itemDetail">
        <img id="itemDetailImage" src="" alt="Item Detail">
        <p id="itemDetailName"></p>
        <button onclick="buyItem()">–ö—É–ø–∏—Ç—å</button>
        <button onclick="closeItemDetail()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="continuePrompt">
        <img id="victoryImage" src="win2.png" alt="–í—ã –ø–æ–±–µ–¥–∏–ª–∏" style="display: none; width: 10px; height: 10px; position: relative; z-index: 3000;">
        <p>Shap –≤ –ø–µ—á–∞–ª–∏, —á—Ç–æ –≤—ã –µ–≥–æ –±—å–µ—Ç–µ :(</p>
        <p>–í—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–Ω–∏–∂–∞—Ç—å Shap –∏ —É–±–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞?</p>
        <div id="goldEarned" style="display: none; font-size: 24px; color: gold; font-family: 'Comic Sans MS', cursive, sans-serif;">–ó–æ–ª–æ—Ç–æ: <span id="goldAmount"></span></div>
        
    </div>
    
    
    
    <div class="monster-message" id="monsterMessage"></div>
    <script type="module">

let rewardMultiplier = 1; // –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è –Ω–∞–≥—Ä–∞–¥—ã
let currentClan = null;  // –¢–µ–∫—É—â–∏–π –∫–ª–∞–Ω –∏–≥—Ä–æ–∫–∞
let currentChat = 'global'; // –¢–µ–∫—É—â–∏–π —á–∞—Ç (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

    // –î–∞–Ω–Ω—ã–µ –æ –≥–µ—Ä–æ—è—Ö
    let allHeroes = [
    { name: '–≠–ª—å—Ñ', level: 1, baseDamage: 5, baseCost: 50, damage: 5, cost: 50, img: 'hero1.png', hired: false },
    { name: '–ì–Ω–æ–º', level: 1, baseDamage: 10, baseCost: 100, damage: 10, cost: 100, img: 'hero2.png', hired: false },
    { name: '—Ö–æ–±–±–∏—Ç', level: 1, baseDamage: 20, baseCost: 250, damage: 20, cost: 250, img: 'hero3.png', hired: false },
    { name: '–¢–æ—Ä', level: 1, baseDamage: 30, baseCost: 500, damage: 30, cost: 500, img: 'hero4.png', hired: false },
    { name: '–ö—É–∑–Ω–µ—á–∏–∫', level: 1, baseDamage: 40, baseCost: 1000, damage: 40, cost: 1000, img: 'hero5.png', hired: false },
    { name: '–õ–µ—Å–Ω–æ–π –∑–≤–µ—Ä–µ–∫', level: 1, baseDamage: 60, baseCost: 2000, damage: 60, cost: 2000, img: 'hero6.png', hired: false },
    { name: '–î—é–π–º–æ–≤–æ—á–∫–∞', level: 1, baseDamage: 80, baseCost: 4000, damage: 80, cost: 4000, img: 'hero7.png', hired: false },
    { name: '–ó–µ–≤—Å', level: 1, baseDamage: 100, baseCost: 8000, damage: 100, cost: 8000, img: 'hero8.png', hired: false },
    { name: '–ê–ø–æ–ª–ª–æ–Ω', level: 1, baseDamage: 120, baseCost: 16000, damage: 120, cost: 16000, img: 'hero9.png', hired: false },
    { name: '–û–ª–∏–º–ø', level: 1, baseDamage: 200, baseCost: 100000, damage: 200, cost: 100000, img: 'hero10.png', hired: false }
];
let initialHeroes = allHeroes.slice(0, 5); // –ù–∞—á–∞–ª—å–Ω—ã–µ –≥–µ—Ä–æ–∏
let heroes = [...initialHeroes];
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤


const dailyQuests = [
    { description: '–£–±–∏—Ç—å 10 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 10, progress: 0, reward: 500, completed: false },
    { description: '–£–±–∏—Ç—å 30 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 30, progress: 0, reward: 1000, completed: false },
    { description: '–£–±–∏—Ç—å 60 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 60, progress: 0, reward: 2500, completed: false },
    { description: '–£–±–∏—Ç—å 100 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 100, progress: 0, reward: 5000, completed: false },
    { description: '–£–±–∏—Ç—å 150 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 150, progress: 0, reward: 8000, completed: false },
    { description: '–£–±–∏—Ç—å 210 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 210, progress: 0, reward: 12000, completed: false },
    { description: '–£–±–∏—Ç—å 280 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 280, progress: 0, reward: 17000, completed: false },
    { description: '–£–±–∏—Ç—å 360 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 360, progress: 0, reward: 23000, completed: false },
    { description: '–£–±–∏—Ç—å 450 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 450, progress: 0, reward: 30000, completed: false },
    { description: '–£–±–∏—Ç—å 550 –º–æ–Ω—Å—Ç—Ä–æ–≤', goal: 550, progress: 0, reward: 40000, completed: false }
];


function showRebornPrompt() {
    const playerLevel = currentLevel;
    let rebornPossible = false;
    let nextRebornLevel = 0;

    if (rebornCount === 0 && playerLevel >= 10) {
        rebornPossible = true;
        nextRebornLevel = 20;
    } else if (rebornCount === 1 && playerLevel >= 20) {
        rebornPossible = true;
        nextRebornLevel = 30;
    } else if (rebornCount === 2 && playerLevel >= 30) {
        rebornPossible = true;
        nextRebornLevel = 40;
    } else if (rebornCount === 3 && playerLevel >= 40) {
        rebornPossible = true;
        nextRebornLevel = 50;
    } else if (rebornCount === 4 && playerLevel >= 50) {
        rebornPossible = true;
        nextRebornLevel = 60;
    } else if (rebornCount === 5 && playerLevel >= 60) {
        rebornPossible = true;
        nextRebornLevel = 70;
    } else if (playerLevel >= 100) {
        rebornPossible = true;
        nextRebornLevel = playerLevel + 10; // –∏–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è
    }
     else {  //  –î–æ–±–∞–≤—å—Ç–µ  —ç—Ç–æ  —É—Å–ª–æ–≤–∏–µ üëá
        rebornPossible = false;
        //  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º  nextRebornLevel  –≤  —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å  –ª–æ–≥–∏–∫–æ–π  –≤–∞—à–µ–π –∏–≥—Ä—ã 
        nextRebornLevel =  rebornCount * 10 + 10; 
    }

    if (rebornPossible) {
        
        document.getElementById('rebornMenu').style.display = 'block'; 
        document.getElementById('rebornMessage').textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å  —É—Ä–æ–≤–Ω–µ–π, –Ω–∞–Ω—è—Ç—ã–µ  –≥–µ—Ä–æ–∏  –∏  –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–µ –∑–æ–ª–æ—Ç–æ  –±—É–¥—É—Ç  —Å–±—Ä–æ—à–µ–Ω—ã.  –ù–æ –≤—ã  –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å  –Ω–∞–≥—Ä–∞–¥—ã  –∑–∞  —É–±–∏–π—Å—Ç–≤–æ –º–æ–Ω—Å—Ç—Ä–æ–≤  –≤  ${1  +  rebornCount * 0.1}  —Ä–∞–∑–∞  –≤—ã—à–µ. 
                                                                  –¢–∞–∫–∂–µ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã  –Ω–æ–≤—ã–µ  –≥–µ—Ä–æ–∏  –¥–ª—è  –Ω–∞–π–º–∞. –°–ª–µ–¥—É—é—â–µ–µ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ  –¥–æ—Å—Ç—É–ø–Ω–æ —Å  —É—Ä–æ–≤–Ω—è  ${nextRebornLevel}.`; 
    } else {
        //  –û—Ç–æ–±—Ä–∞–∂–∞–µ–º  —Ç—Ä–µ–±—É–µ–º—ã–π  —É—Ä–æ–≤–µ–Ω—å 
        document.getElementById('errorMessage').style.display = 'block'; 
        document.getElementById('errorMessageText').textContent = `–í–∞—à  —É—Ä–æ–≤–µ–Ω—å  —Å–ª–∏—à–∫–æ–º  –Ω–∏–∑–æ–∫  –¥–ª—è  –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è!  
                                                                    –¢—Ä–µ–±—É–µ—Ç—Å—è  —É—Ä–æ–≤–µ–Ω—å:  ${nextRebornLevel}.`; 
    }
}
window.showRebornPrompt = showRebornPrompt;

// –§—É–Ω–∫—Ü–∏—è  –¥–ª—è  –∑–∞–∫—Ä—ã—Ç–∏—è  –æ–∫–Ω–∞  —Å–æ–æ–±—â–µ–Ω–∏—è  –æ–±  –æ—à–∏–±–∫–µ 
function closeErrorMessage() {
    document.getElementById('errorMessage').style.display = 'none';
}
window.closeErrorMessage = closeErrorMessage;

//  –§—É–Ω–∫—Ü–∏—è  –¥–ª—è  –∑–∞–∫—Ä—ã—Ç–∏—è  –æ–∫–Ω–∞  –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è  
function closeRebornMenu()  {
    document.getElementById('rebornMenu').style.display =  'none'; 
}
window.closeRebornMenu = closeRebornMenu;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è
function confirmReborn() {
    hideRebornPrompt();
    levels = new Array(10000).fill().map((_, i) => ({ number: i + 1, stars: 0, completed: false }));
    heroes.forEach(hero => {
        const baseDamage = hero.baseDamage || 0;
        const baseCost = hero.baseCost || 0;

        hero.level = 0;
        hero.hired = false;
        hero.damage = calculateHeroStats(1, baseDamage, baseCost).newDamage;
        hero.cost = baseCost;
    });
    currentLevel = 1;
    rebornCount++;
    rewardMultiplier = Math.min(1 + rebornCount * 0.1, 9999);
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–µ—Ä–æ–µ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –≥–µ—Ä–æ–µ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è
    heroes = allHeroes;

    updateGold(100).then(() => {
        updateCharacterMenu();
        addHeroesToMenu();
        startLevel(currentLevel);
        closeRebornMenu(); 
        document.getElementById('rebornSuccessMessage').style.display = 'block';
        document.getElementById('rebornSuccessMessageText').textContent = `–í—ã  –ø–µ—Ä–µ—Ä–æ–¥–∏–ª–∏—Å—å! 
                                                                            –¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å  –Ω–∞–≥—Ä–∞–¥—ã –∑–∞  —É–±–∏–π—Å—Ç–≤–æ  –º–æ–Ω—Å—Ç—Ä–æ–≤  –≤  ${rewardMultiplier.toFixed(1)} —Ä–∞–∑–∞ –≤—ã—à–µ.`;
        
        saveProgress().then(() => {
            console.log('Progress saved after reborn');
            updateStatusBar();
        }).catch(error => {
            console.error('Error saving progress after reborn:', error);
        });
    }).catch(error => {
        console.error('Error updating gold:', error);
    });
}
window.confirmReborn = confirmReborn;

//  –§—É–Ω–∫—Ü–∏—è  –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–∏  
function closeRebornSuccessMessage() {
    document.getElementById('rebornSuccessMessage').style.display = 'none';
}
window.closeRebornSuccessMessage = closeRebornSuccessMessage;



//  –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π  
function  openDailyQuestsMenu()  { 
    document.getElementById('dailyQuestsMenu').style.display = 'block';
    updateDailyQuestsUI(); 
}
window.openDailyQuestsMenu  = openDailyQuestsMenu;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é  –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π  
function  closeDailyQuestsMenu()  { 
    document.getElementById('dailyQuestsMenu').style.display =  'none'; 
} 
window.closeDailyQuestsMenu  = closeDailyQuestsMenu;

// –§—É–Ω–∫—Ü–∏—è  –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI  –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π 
function updateDailyQuestsUI() { 
    const  dailyQuestsList  = document.getElementById('dailyQuestsList'); 
    dailyQuestsList.innerHTML =  '';

    dailyQuests.forEach((quest,  index)  =>  {
        const  questItem = document.createElement('li');
        questItem.textContent = `${quest.description} (${quest.progress}/${quest.goal}) - –ù–∞–≥—Ä–∞–¥–∞: ${quest.reward} –∑–æ–ª–æ—Ç–∞`;

        // –î–æ–±–∞–≤–ª—è–µ–º  –∫–Ω–æ–ø–∫—É  "–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É"  
        if (quest.completed)  { 
            const  claimRewardButton =  document.createElement('button');
            claimRewardButton.textContent = '–ü–æ–ª—É—á–∏—Ç—å  –Ω–∞–≥—Ä–∞–¥—É'; 
            claimRewardButton.onclick = () => {  claimDailyQuestReward(index); }; 
            questItem.appendChild(claimRewardButton); 
        }

        dailyQuestsList.appendChild(questItem); 
    });

    //  –î–æ–±–∞–≤–ª—è–µ–º  –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é  –æ  —Å–±—Ä–æ—Å–µ –∑–∞–¥–∞–Ω–∏–π
    const resetTimeElement =  document.createElement('p'); 
    resetTimeElement.id  =  'dailyQuestResetTime'; 
    resetTimeElement.textContent =  `–°–±—Ä–æ—Å  —á–µ—Ä–µ–∑: ${getTimeUntilDailyQuestReset()}`;

    // –î–æ–±–∞–≤–ª—è–µ–º resetTimeElement  –≤  dailyQuestsList  –∑–∞  –ø—Ä–µ–¥–µ–ª–∞–º–∏  —Ü–∏–∫–ª–∞ 
    dailyQuestsList.appendChild(resetTimeElement);
}

//  –§—É–Ω–∫—Ü–∏—è –¥–ª—è  –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã –∑–∞  –∑–∞–¥–∞–Ω–∏–µ
function claimDailyQuestReward(questIndex) { 
    if  (dailyQuests[questIndex].completed) { 
        updateGold(gold  + dailyQuests[questIndex].reward); 
        
        // –£–¥–∞–ª—è–µ–º  –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ  –∑–∞–¥–∞–Ω–∏–µ –∏–∑  —Å–ø–∏—Å–∫–∞  
        dailyQuests.splice(questIndex, 1);

        updateDailyQuestsUI(); 
        saveProgress(); 
    }
}
window.claimDailyQuestReward = claimDailyQuestReward;



// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π 
async function resetDailyQuests() {
    console.log("–°–±—Ä–æ—Å  –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π...");

    dailyQuests.forEach(quest => { 
        quest.progress = 0;
        quest.completed = false;
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–¥–∞–Ω–∏–π 
    await saveProgress();
    
    //  –û–±–Ω–æ–≤–ª—è–µ–º UI  –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞  
    updateDailyQuestsUI();
    
    console.log("–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã!"); 
}
window.resetDailyQuests = resetDailyQuests;
//  –ó–∞–ø—É—Å–∫–∞–µ–º  —Ç–∞–π–º–µ—Ä  –¥–ª—è  –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –∑–∞–¥–∞–Ω–∏–π  
setInterval(resetDailyQuests,  1000  *  60  * 60  * 24);  //  –í—ã–∑—ã–≤–∞–µ–º  –∫–∞–∂–¥—ã–µ  24 —á–∞—Å–∞


//  –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏  –¥–æ  —Å–±—Ä–æ—Å–∞  –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π
function  getTimeUntilDailyQuestReset()  {
    const now  =  new  Date(); 
    const  resetHour  =  0;  //  –ß–∞—Å  —Å–±—Ä–æ—Å–∞  (00:00  UTC)  
    const resetTime = new Date(now);
    resetTime.setUTCHours(resetHour, 0,  0,  0); 

    // –ï—Å–ª–∏ –≤—Ä–µ–º—è  —Å–±—Ä–æ—Å–∞ —É–∂–µ  –ø—Ä–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è,  —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º  –µ–≥–æ  –Ω–∞  –∑–∞–≤—Ç—Ä–∞
    if  (now  >=  resetTime)  { 
        resetTime.setUTCDate(resetTime.getUTCDate()  +  1);
    }

    const  timeDifference  = resetTime.getTime()  - now.getTime();
    const  hours =  Math.floor(timeDifference  / (1000  *  60  *  60)); 
    const minutes  = Math.floor((timeDifference  %  (1000  *  60  *  60)) /  (1000  *  60));

    return `${hours} —á ${minutes}  –º–∏–Ω`; 
}








function showGameMessage(message) {
  const gameMessage = document.getElementById('gameMessage');
  const gameMessageText = document.getElementById('gameMessageText');
  gameMessageText.textContent = message;
  gameMessage.style.display = 'block';

  // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ  —á–µ—Ä–µ–∑  3  —Å–µ–∫—É–Ω–¥—ã
  setTimeout(()  =>  {
    gameMessage.style.display = 'none'; 
  },  3000);
}
window.showGameMessage = showGameMessage; 


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤
function migrateHeroData(oldHeroes) {
    return oldHeroes.map(oldHero => {
        const newHero = allHeroes.find(hero => hero.name === oldHero.name);
        if (newHero) {
            return {
                ...newHero,
                level: oldHero.level,
                damage: calculateHeroStats(oldHero.level, newHero.baseDamage, newHero.baseCost).newDamage,
                cost: calculateHeroStats(oldHero.level, newHero.baseDamage, newHero.baseCost).newCost,
                hired: oldHero.hired,
            };
        }
        return oldHero;
    });
}
window.migrateHeroData = migrateHeroData;








function createHeroElement(hero) {
    const heroDiv = document.createElement('div');
    heroDiv.className = `hero ${hero.hired ? 'hired' : 'not-hired'}`;

    const heroImg = document.createElement('img');
    heroImg.src = hero.img;
    heroImg.alt = hero.name;
    heroDiv.appendChild(heroImg);

    const heroName = document.createElement('p');
    heroName.textContent = hero.name;
    heroDiv.appendChild(heroName);

    const heroLevel = document.createElement('p');
    heroLevel.textContent = `–£—Ä.: ${hero.level}`;
    heroDiv.appendChild(heroLevel);

    const heroDamage = document.createElement('p');
    heroDamage.textContent = `–£—Ä–æ–Ω: ${hero.damage}`;
    heroDiv.appendChild(heroDamage);

    const heroCost = document.createElement('p');
    const upgradeCost = hero.hired ? calculateHeroStats(hero.level + 1, hero.baseDamage, hero.baseCost).newCost : hero.cost;
    heroCost.textContent = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${upgradeCost}`;
    heroDiv.appendChild(heroCost);

    const hireButton = document.createElement('button');
    hireButton.className = hero.hired ? 'upgrade-button' : 'hire-button'; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –∫–Ω–æ–ø–∫–µ
    hireButton.textContent = hero.hired ? '–£–ª—É—á—à–∏—Ç—å' : '–ù–∞–Ω—è—Ç—å';
    hireButton.onclick = () => {
        hireOrUpgradeHero(hero, heroDiv, hireButton);
    };
    heroDiv.appendChild(hireButton);

    return heroDiv;
}

window.createHeroElement = createHeroElement;


    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–µ—Ä–æ–µ–≤ –≤ –º–µ–Ω—é
    function addHeroesToMenu() {
    const leftCharacterMenu = document.getElementById('leftCharacterMenu');
    leftCharacterMenu.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –º–µ–Ω—é –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≥–µ—Ä–æ–µ–≤
    heroes.forEach(hero => {
        const heroElement = createHeroElement(hero);
        leftCharacterMenu.appendChild(heroElement);
    });
}
window.addHeroesToMenu = addHeroesToMenu;

async  function displayLastPvpBattles() {
  const battlesRef = ref(database, 'pvpBattles');
  const battlesSnapshot = await get(battlesRef);

  if (battlesSnapshot.exists()) {
    const battlesData = battlesSnapshot.val();
    const battlesArray = Object.values(battlesData);

    //  –°–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏—Ç–≤—ã –ø–æ  –≤—Ä–µ–º–µ–Ω–∏  (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–≤–µ—Ä—Ö—É)  
    battlesArray.sort((a, b) =>  b.timestamp  - a.timestamp);  

    const last5Battles =  battlesArray.slice(0,  5); // –ë–µ—Ä–µ–º  –ø–æ—Å–ª–µ–¥–Ω–∏–µ  5  –±–∏—Ç–≤
    const battleList =  document.getElementById('pvpLastBattles');

    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ø–∏—Å–æ–∫  –±–∏—Ç–≤
    battleList.innerHTML = '';

    //  –°–ø–∏—Å–æ–∫  –¥–ª—è  –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ  –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–Ω—ã—Ö  –ø–∞—Ä –∏–≥—Ä–æ–∫–æ–≤  
    const  displayedBattles = new  Set();  

    last5Battles.forEach((battle,  index)  => {  //  –ü–µ—Ä–µ–¥–∞–µ–º  index  –≤ forEach
        //  –°–æ–∑–¥–∞–µ–º  —É–Ω–∏–∫–∞–ª—å–Ω—ã–π  –∫–ª—é—á  –¥–ª—è  –ø–∞—Ä—ã –∏–≥—Ä–æ–∫–æ–≤
        //  –°–æ—Ä—Ç–∏—Ä—É–µ–º  –Ω–∏–∫–Ω–µ–π–º—ã, —á—Ç–æ–±—ã  –∫–ª—é—á  –±—ã–ª  –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º  –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç  –ø–æ—Ä—è–¥–∫–∞  –∏–≥—Ä–æ–∫–æ–≤ 
        const battleKey = [battle.player1,  battle.player2].sort().join('-');  

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º,  –±—ã–ª–∞  –ª–∏ —ç—Ç–∞  –ø–∞—Ä–∞  –∏–≥—Ä–æ–∫–æ–≤  —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞
        if (displayedBattles.has(battleKey))  {
            return; //  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º  –±–∏—Ç–≤—É 
        } 

        // –î–æ–±–∞–≤–ª—è–µ–º  –ø–∞—Ä—É  –∏–≥—Ä–æ–∫–æ–≤  –≤ —Å–ø–∏—Å–æ–∫  –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–Ω—ã—Ö 
        displayedBattles.add(battleKey);  

        const battleItem =  document.createElement('li'); 
        const winner = battle.winner ===  'player' ? battle.player1 : battle.player2;  
        battleItem.textContent = `${battle.player1}  vs  ${battle.player2}  - –ü–æ–±–µ–¥–∏–ª:  ${winner}`; 
        battleList.appendChild(battleItem);

        //  –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏  —Ç–µ–∫—Å—Ç  –∫–∞–∂–¥–æ–π –±–∏—Ç–≤—ã
        console.log(`–ë–∏—Ç–≤–∞  ${index  + 1}:`,  {
            text: battleItem.textContent, 
            x: battleItem.getBoundingClientRect().x, 
            y:  battleItem.getBoundingClientRect().y, 
        });
    }); 

    // –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ä–∞–∑–º–µ—Ä—ã  –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞  —Å–ø–∏—Å–∫–∞ –±–∏—Ç–≤ 
    const battleListRect  = battleList.getBoundingClientRect(); 
    console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä  —Å–ø–∏—Å–∫–∞  –±–∏—Ç–≤:',  { 
        x: battleListRect.x,
        y:  battleListRect.y, 
        width: battleListRect.width, 
        height: battleListRect.height
    });

  } else  {
    console.log("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö  –æ PvP-–±–∏—Ç–≤–∞—Ö");
  }
}

function hireOrUpgradeHero(hero, heroDiv, hireButton) {
    console.log(`–ù–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏ hireOrUpgradeHero –¥–ª—è ${hero.name}, —É—Ä–æ–≤–µ–Ω—å: ${hero.level}, –∑–æ–ª–æ—Ç–æ: ${gold}`);

    if (!hero.hired && gold >= hero.cost) {
        // –ù–∞–π–º –≥–µ—Ä–æ—è
        console.log(`–ù–∞–π–º –≥–µ—Ä–æ—è ${hero.name} –∑–∞ ${hero.cost} –∑–æ–ª–æ—Ç–∞`);
        gold -= hero.cost;
        hero.hired = true;
        hero.level = 1; 
        const stats = calculateHeroStats(hero.level, hero.baseDamage, hero.baseCost);
        hero.damage = stats.newDamage;
        hero.cost = calculateHeroStats(hero.level + 1, hero.baseDamage, hero.baseCost).newCost; 
        totalDamage += hero.damage;
        console.log(`–ì–µ—Ä–æ–π ${hero.name} –Ω–∞–Ω—è—Ç: —É—Ä–æ–≤–µ–Ω—å ${hero.level}, —É—Ä–æ–Ω ${hero.damage}, —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è ${hero.cost}`);
        heroDiv.classList.remove('not-hired');
        heroDiv.classList.add('hired');
        hireButton.textContent = '–£–ª—É—á—à–∏—Ç—å';
        updateHeroElement(hero, heroDiv); 

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–ª–∞–Ω–µ
        updateClanMemberData(nickname, {
            level: currentLevel, 
            damage: calculateTotalDamage()  
        });
    } else if (hero.hired) {
        // –£–ª—É—á—à–µ–Ω–∏–µ –≥–µ—Ä–æ—è
        console.log(`–£–ª—É—á—à–µ–Ω–∏–µ –≥–µ—Ä–æ—è ${hero.name}`);
        const stats = calculateHeroStats(hero.level + 1, hero.baseDamage, hero.baseCost);
        const upgradeCost = stats.newCost;
        console.log(`–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è: ${hero.cost}, –ù–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è: ${upgradeCost}`);
        if (gold >= upgradeCost) {
            console.log(`–ì–µ—Ä–æ–π ${hero.name} —É–ª—É—á—à–∞–µ—Ç—Å—è –∑–∞ ${upgradeCost} –∑–æ–ª–æ—Ç–∞`);
            gold -= upgradeCost;
            totalDamage -= hero.damage;
            hero.level++;
            hero.damage = stats.newDamage;
            hero.cost = calculateHeroStats(hero.level + 1, hero.baseDamage, hero.baseCost).newCost; 
            totalDamage += hero.damage;
            console.log(`–ì–µ—Ä–æ–π ${hero.name} —É–ª—É—á—à–µ–Ω: —É—Ä–æ–≤–µ–Ω—å ${hero.level}, —É—Ä–æ–Ω ${hero.damage}, —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è ${hero.cost}`);
            hireButton.textContent = '–£–ª—É—á—à–∏—Ç—å';
            updateHeroElement(hero, heroDiv); 

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–ª–∞–Ω–µ
            updateClanMemberData(nickname, {
                level: currentLevel,
                damage: calculateTotalDamage()
            }); 
        } else {
            console.log('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è!');
        }
    } else {
        console.log('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è –Ω–∞–π–º–∞!');
    }

    updateTotalDamage();
    localGoldUpdated = true;
    updateStatusBar();
    saveGoldToDatabase().then(() => {
        console.log(`–ó–æ–ª–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: ${gold}`);
    });
    savePlayerData();
    console.log(`–ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ hireOrUpgradeHero –¥–ª—è ${hero.name}, —É—Ä–æ–≤–µ–Ω—å: ${hero.level}, –∑–æ–ª–æ—Ç–æ: ${gold}`);
}
window.hireOrUpgradeHero = hireOrUpgradeHero;















function saveGoldToDatabase() {
    const playerGoldRef = ref(database, `players/${nickname}/gold`);
    return set(playerGoldRef, gold).then(() => {
        console.log(`Gold saved to database: ${gold}`);
    }).catch((error) => {
        console.error('Error saving gold to database:', error);
        throw error;
    });
}

function updateHeroElement(hero, heroDiv) {
    console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≥–µ—Ä–æ—è ${hero.name}: —É—Ä–æ–≤–µ–Ω—å ${hero.level}, —É—Ä–æ–Ω ${hero.damage}, —Å—Ç–æ–∏–º–æ—Å—Ç—å ${hero.cost}`);
    heroDiv.querySelector('p:nth-child(3)').textContent = `–£—Ä.: ${hero.level}`;
    heroDiv.querySelector('p:nth-child(4)').textContent = `–£—Ä–æ–Ω: ${hero.damage}`;
    heroDiv.querySelector('p:nth-child(5)').textContent = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${hero.cost}`;
    console.log(`–≠–ª–µ–º–µ–Ω—Ç –≥–µ—Ä–æ—è ${hero.name} –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ: —É—Ä–æ–≤–µ–Ω—å ${heroDiv.querySelector('p:nth-child(3)').textContent}, —É—Ä–æ–Ω ${heroDiv.querySelector('p:nth-child(4)').textContent}, —Å—Ç–æ–∏–º–æ—Å—Ç—å ${heroDiv.querySelector('p:nth-child(5)').textContent}`);
}
window.updateHeroElement = updateHeroElement;





// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É–º–º–∞—Ä–Ω–æ–≥–æ —É—Ä–æ–Ω–∞
function updateTotalDamage() {
    totalDamage = calculateTotalDamage();
    const totalDamageElement = document.getElementById('totalDamage');
    if (totalDamageElement) {
        totalDamageElement.textContent = `–°—É–º–º–∞—Ä–Ω—ã–π —É—Ä–æ–Ω: ${totalDamage}`;
    }


}
window.updateTotalDamage = updateTotalDamage;


function calculateHeroStats(level, baseDamage, baseCost) {
    const damageMultiplier = 2; // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è —É—Ä–æ–Ω–∞
    const costMultiplier = 2.4; // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    const newDamage = Math.floor(baseDamage * Math.pow(damageMultiplier, level - 1));
    const newCost = Math.floor(baseCost * Math.pow(costMultiplier, level - 1));
    console.log(`–†–∞—Å—á–µ—Ç –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —É—Ä–æ–≤–Ω—è ${level}: —É—Ä–æ–Ω ${newDamage}, —Å—Ç–æ–∏–º–æ—Å—Ç—å ${newCost}`);
    return { newDamage, newCost };
}
window.calculateHeroStats = calculateHeroStats;





import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-app.js";
import { getDatabase, ref, set, get, child, runTransaction, onValue, push, off, remove } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCPQFqbWCL3XaM-sLYDWgWMdslhS7O7WC8",
            authDomain: "game-7bdb0.firebaseapp.com",
            databaseURL: "https://game-7bdb0-default-rtdb.firebaseio.com",
            projectId: "game-7bdb0",
            storageBucket: "game-7bdb0.appspot.com",
            messagingSenderId: "327382187542",
            appId: "1:327382187542:web:cc82e8673791983404bf37",
            measurementId: "G-8JBZ9PEV84"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.currentSessionId = null;

function startSession(nickname) {
    const sessionId = generateSessionId();
    set(ref(database, 'players/' + nickname + '/session'), sessionId);
    return sessionId;
}











async function saveProgress() {
    if (!nickname || !currentSessionId) {
        console.error('Cannot save progress: no nickname or session ID');
        return;
    }

    const progressData = {
        currentLevel: currentLevel,
        gold: gold,
        playerHealth: playerHealth,
        weaponPower: weaponPower,
        weaponName: weaponName,
        weaponLevel: weaponLevel || 0,
        heroes: heroes,
        levels: levels,
        session: currentSessionId,
        monsterHealth: monsterHealth,
        rewardMultiplier: rewardMultiplier,
        rebornCount: rebornCount, 
        currentClan: currentClan // –î–æ–±–∞–≤–∏–ª–∏ currentClan 
    };
    console.log('Saving progress:', progressData);
    try {
        const dbRef = ref(database, `players/${nickname}/progress`);
        const sessionRef = ref(database, `players/${nickname}/session`);
        const sessionSnapshot = await get(sessionRef);
        if (sessionSnapshot.val() !== currentSessionId) {
            console.log(`Session mismatch, progress not saved. Current session: ${currentSessionId}, Server session: ${sessionSnapshot.val()}`);
            alert('–°–µ—Å—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å. –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
            return;
        }
        await set(dbRef, progressData);
        console.log('Data saved successfully:', progressData);
    } catch (error) {
        console.error('Error saving progress:', error);
    }
}

window.saveProgress = saveProgress;








function savePlayerData() {
    if (nickname && currentSessionId) {
        saveProgress(nickname, currentSessionId, {
            currentLevel,
            gold,
            playerHealth,
            weaponPower,
            weaponName,
            weaponLevel,
            levels,
            heroes // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –≥–µ—Ä–æ—è—Ö
        });
    }
}



function validateData(data) {
    if (!data || typeof data !== 'object') return false;
    if (!Array.isArray(data.heroes)) return false;
    return true;
}


// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–≥—Ä–æ–∫–∞
async function loadProgress(nickname) {
    if (!nickname) {
        console.error('Cannot load progress: no nickname');
        return;
    }

    try {
        const dbRef = ref(database, `players/${nickname}/progress`);
        const snapshot = await get(dbRef);
        if (snapshot.exists()) {
            const data = snapshot.val();
            console.log('Loaded progress:', data);

            data.heroes = migrateHeroData(data.heroes); // –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤

            applyProgress(data);
            saveProgress();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ  –æ –∫–ª–∞–Ω–∞—Ö  –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏  –ø—Ä–æ–≥—Ä–µ—Å—Å–∞  –∏–≥—Ä–æ–∫–∞
    const  clansSnapshot =  await get(ref(database, 'clans')); 
    if (clansSnapshot.exists()) {
        clans =  clansSnapshot.val();
    } else {
        clans = {};
    }

    //  –í—ã–∑—ã–≤–∞–µ–º  resetClanIfInvalid  –ø–æ—Å–ª–µ  –∑–∞–≥—Ä—É–∑–∫–∏  clans
    await resetClanIfInvalid(nickname,  data); // –ü–µ—Ä–µ–¥–∞–µ–º  data
            

            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º  –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ  –∏–≥—Ä–æ–∫–∞  –≤  –∫–ª–∞–Ω–µ
            await isPlayerInClan(nickname); //  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º  currentClan
            
            return data;
        } else {
            console.log('No progress found for', nickname);
            return null;
        }
    } catch (error) {
        console.error('Error loading progress:', error);
        return null;
    }
}


window.loadProgress = loadProgress;



// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function applyProgress(data) {
    if (data && validateData(data)) {
        currentLevel = data.currentLevel;
        gold = data.gold;
        playerHealth = data.playerHealth;
        weaponPower = data.weaponPower;
        weaponName = data.weaponName;
        weaponLevel = data.weaponLevel || 0;

        heroes = data.heroes.map(hero => {
            const baseDamage = hero.baseDamage !== undefined ? hero.baseDamage : 0;
            const baseCost = hero.baseCost !== undefined ? hero.baseCost : 0;
            const level = hero.level || 1;

            return {
                ...hero,
                baseDamage: baseDamage,
                baseCost: baseCost,
                cost: isNaN(hero.cost) || hero.cost === undefined ? baseCost : hero.cost,
                damage: isNaN(hero.damage) || hero.damage === undefined ? calculateHeroStats(level, baseDamage, baseCost).newDamage : hero.damage,
                level: level
            };
        });

        levels = data.levels || levels;
        monsterHealth = data.monsterHealth || baseMonsterHealth; 
        rewardMultiplier = data.rewardMultiplier || 1;
        rebornCount = data.rebornCount || 0;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∞–Ω–µ
        if (data.currentClan) {
            currentClan = data.currentClan;
        }

        console.log('Applying progress:', data);
        console.log(`Gold after applying progress: ${gold}`);
        console.log(`currentClan after applying progress: ${currentClan}`);


        updateCharacterMenu();
        addHeroesToMenu();
        updateTotalDamage(); 
        updateStatusBar();
        
    }
}

window.applyProgress = applyProgress;

async function startGame() {
    const input = document.getElementById('nicknameInput').value;
    console.log(`Nickname entered: ${input}`);
    if (input) {
        nickname = input;
        const dbRef = ref(database, `players/${nickname}/session`);

        try {
            const sessionSnapshot = await get(dbRef);
            if (sessionSnapshot.exists()) {
                const existingSessionId = sessionSnapshot.val();
                console.log(`Existing session found for ${nickname}: ${existingSessionId}`);
                await endSession(nickname, existingSessionId);
            } else {
                console.log(`No existing session found for ${nickname}`);
            }

            const newSessionId = generateSessionId();
            await set(dbRef, newSessionId);
            currentSessionId = newSessionId;
            console.log(`New session started for ${nickname}: ${newSessionId}`);
            watchSessionChanges();
            listenForOpponent();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö 
            let progressData = await loadProgress(nickname);

            // –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –∏–≥—Ä–æ–∫–∞
            if (!progressData) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                const playerGoldRef = ref(database, `players/${nickname}/gold`);
                await set(playerGoldRef, 100); 
                console.log('Initial gold set to 100 for new player');

                //  –°–æ–∑–¥–∞–µ–º  –ø—É—Å—Ç—É—é  –∑–∞–ø–∏—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞  
                progressData = { currentClan: null };  
                applyProgress(progressData);
                await saveProgress();
            }

            continueGameSetup();
            //await updateClanList(); 
        } catch (error) {
            console.error('Error starting new session:', error);
        }
    } else {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º.');
    }
}
window.startGame = startGame; 

async function continueGameSetup() {
    const data = await loadProgress(nickname);
    console.log(`Data loaded: ${JSON.stringify(data)}`);
    applyProgress(data);

    document.getElementById('nicknameMenu').style.display = 'none';
    document.getElementById('gameCanvas').style.display = 'block';
    document.getElementById('bottomMenu').style.display = 'flex';
    document.getElementById('leftCharacterMenu').style.display = 'block'; 
    document.getElementById('chatContainer').style.display = 'flex';

    currentScreen = 'dungeon';
    console.log(`Screen set to: ${currentScreen}`);

    if (data && data.levels) {
        levels = data.levels;
    }

    initializeMonster(baseMonsterHealth * Math.pow(1.1, currentLevel - 1));
    drawMenu();
    changeScreen('dungeon');
    updateStatusBar();

    //  –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è  –∫ –∫–ª–∞–Ω–æ–≤–æ–º—É —á–∞—Ç—É, –µ—Å–ª–∏  –∏–≥—Ä–æ–∫  –≤  –∫–ª–∞–Ω–µ  
    if  (currentClan) { 
        listenForClanMessages(currentClan);
    }
}
window.continueGameSetup = continueGameSetup;









function updateHeroCost(hero, heroDiv) {
    const stats = calculateHeroStats(hero.level + 1, hero.baseDamage, hero.baseCost);
    const upgradeCost = stats.newCost;
    heroDiv.querySelector('p:nth-child(5)').textContent = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${upgradeCost}`;
    hero.cost = upgradeCost; // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –≥–µ—Ä–æ—è
}
window.updateHeroCost = updateHeroCost;



// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ–±–æ—è
let isAutoHitting = true; // –ê–≤—Ç–æ–±–æ–π –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let autoHitInterval;

function startAutoHit() {
    if (isAutoHitting) {
        autoHitInterval = setInterval(() => {
            if (currentScreen === 'battle') {
                hitMonster({ clientX: canvas.width / 2, clientY: canvas.height / 2 });
            }
        }, 300);
    }
}
window.startAutoHit = startAutoHit;
function stopAutoHit() {
    clearInterval(autoHitInterval);
}
window.stopAutoHit = stopAutoHit;
function toggleAutoboy() {
    if (isAutoHitting) {
        stopAutoHit();
        isAutoHitting = false;
        document.getElementById('toggleAutoboyButton').textContent = '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–±–æ–π';
    } else {
        isAutoHitting = true;
        startAutoHit();
        document.getElementById('toggleAutoboyButton').textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–±–æ–π';
    }
}
window.toggleAutoboy = toggleAutoboy;
// –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–±–æ—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', startAutoHit);


function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        window.toggleFullscreen = toggleFullscreen;

        function toggleMailWindow() {
    const mailWindow = document.getElementById('mailWindow');
    if (mailWindow.style.display === 'block') {
        mailWindow.style.display = 'none';
    } else {
        mailWindow.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–π –ø–æ—á—Ç—ã
        loadMail();
        mailWindow.style.display = 'block';
    }
}
window.toggleMailWindow = toggleMailWindow;


const characterImages = [
    'peasant.png',     // 0-9 —É—Ä–æ–≤–µ–Ω—å
    'warrior.png',     // 10-19 —É—Ä–æ–≤–µ–Ω—å
    'knight.png',      // 20-29 —É—Ä–æ–≤–µ–Ω—å
    'mage.png',        // 30-39 —É—Ä–æ–≤–µ–Ω—å
    'archer.png',      // 40-49 —É—Ä–æ–≤–µ–Ω—å
    'paladin.png',     // 50-59 —É—Ä–æ–≤–µ–Ω—å
    'barbarian.png',   // 60-69 —É—Ä–æ–≤–µ–Ω—å
    'assassin.png',    // 70-79 —É—Ä–æ–≤–µ–Ω—å
    'samurai.png',     // 80-89 —É—Ä–æ–≤–µ–Ω—å
    'dragon_knight.png' // 90-99 —É—Ä–æ–≤–µ–Ω—å
];

function updateCharacterImage() {
    const index = Math.floor(currentLevel / 10);
    const imageIndex = index < characterImages.length ? index : characterImages.length - 1;
    document.getElementById('characterImage').src = characterImages[imageIndex];
}
window.updateCharacterImage = updateCharacterImage;



function getMonsterImage(level) {
    if (level >= 90) {
        return monsterImages[monsterImages.length - 1];
    }
    const index = Math.floor(level / 10);
    return monsterImages[index % monsterImages.length];
}

window.getMonsterImage = getMonsterImage;

function updateMonsterImage(level) {
    const imageSrc = getMonsterImage(level);
    monsterImage.src = imageSrc;
    //console.log(`Updated monster image to: ${imageSrc} for level ${level}`);
}
window.updateMonsterImage = updateMonsterImage;


        function updateTopPlayers(nickname, playerData) {
            set(ref(database, 'topPlayers/' + nickname), playerData);
        }

        function displayTopPlayers() {
    const dbRef = ref(database);
    return get(child(dbRef, 'topPlayers')).then((snapshot) => {
        if (snapshot.exists()) {
            const topPlayers = snapshot.val();
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é
            const sortedPlayers = Object.values(topPlayers).sort((a, b) => b.level - a.level);
            
            let topListHTML = '<h2>–¢–æ–ø –∏–≥—Ä–æ–∫–∏</h2>';
            sortedPlayers.forEach(player => {
                topListHTML += `<p>${player.nickname} - –£—Ä–æ–≤–µ–Ω—å ${player.level}</p>`;
            });
            document.getElementById('topPlayersMenu').innerHTML = topListHTML;
            return topPlayers;
        } else {
            console.log("No data available");
            return {};
        }
    }).catch((error) => {
        console.error(error);
    });
}

let rebornCount = 0; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π
        let nickname = '';
        let currentSessionId = null;
        
        let currentLevel = 1;
        let gold = 100;
        
        let weaponPower = 10;
        let weaponName = '–ö—É–ª–∞–∫–∏';
        let weaponLevel = 0;
        const monsterMessages = ["–ù–µ –±–µ–π—Ç–µ –º–µ–Ω—è", "–ó–∞ —á—Ç–æ –º–Ω–µ —ç—Ç–æ –≤—Å–µ ?? ", "–∫–∞–∫ —á–µ—Å—Ç–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, —Ç—ã –¥–æ–ª–∂–µ–Ω –Ω–∞ –º–Ω–µ –∂–µ–Ω–∏—Ç—å—Å—è ", "—è –Ω–µ –±—É–¥—É –±–æ–ª—å—à–µ —á–∏—Ç–µ—Ä–∏—Ç—å", "–ø—Ä–æ—Å—Ç–∏—Ç–µ —è –ø—Ä–æ—Å—Ç–æ —Å–ø–ª—é —Å –∞–¥–º–∏–Ω–∞–º–∏ :( )"];

        const monsterImages = [
            'monster1.png',
            'monster2.png',
            'monster3.png',
            'monster4.png',
            'monster5.png',
            'monster6.png',
            'monster7.png',
            'monster8.png',
            'monster9.png',
            'monster10.png'
        ];

let worldBossHealth = 1000000;
let playersDamage = {};
let isUpdating = false;



        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let currentScreen = 'menu';
            let hits = 0;
            let baseMonsterHealth = 100; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ –º–æ–Ω—Å—Ç—Ä–∞
            let monsterHealth = baseMonsterHealth;
            let levels = new Array(10000).fill().map((_, i) => ({ number: i + 1, stars: 0, completed: false }));


        const backgroundImage = new Image();
        backgroundImage.src = 'background.png';
        const castle = new Image();
        castle.src = 'castle.png';
        const arena2 = new Image();
        arena2.src = 'arena.png';
        const dungeonGateImage = new Image();
        dungeonGateImage.src = 'dung.png';
        const monsterImage = new Image();
        //monsterImage.src = 'mob.png';
        const mapImage = new Image();
        mapImage.src = 'map.png';
        const starImage = new Image();
        starImage.src = 'star.png';
        
        const peasantWithSwordImage = 'peasant_with_sword.png';






        starImage.onload = function() {
            drawLevelMap();
        };
        
        // Crosshair logic
        const crosshair = document.getElementById('crosshair');
        document.addEventListener('mousemove', (event) => {
    if (currentScreen === 'battle') {
        crosshair.style.left = `${event.clientX}px`;
        crosshair.style.top = `${event.clientY}px`;
    } else {
        crosshair.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏—Ü–µ–ª, –µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ "battle"
    }
});









        function showHitAnimation() {
            crosshair.style.transition = 'transform 0.1s ease-in-out';
            crosshair.style.transform = 'translate(-50%, -50%) scale(0.8)';
            showMonsterMessage();
            setTimeout(() => {
                crosshair.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 100);
        }
        window.showHitAnimation = showHitAnimation;

        function showMonsterMessage() {
            const message = monsterMessages[Math.floor(Math.random() * monsterMessages.length)];
            const monsterMessage = document.getElementById('monsterMessage');
            monsterMessage.textContent = message;
            monsterMessage.style.display = 'block';
            setTimeout(() => {
                monsterMessage.style.display = 'none';
            }, 500);
        }
        window.showMonsterMessage = showMonsterMessage;
      
        function drawStars(x, y, count) {
    //console.log(`Drawing ${count} stars at (${x}, ${y})`);
    for (let i = 0; i < count; i++) {
        ctx.drawImage(starImage, x + i * 30, y, 20, 20);
    }
}
        window.drawStars = drawStars;

        function toggleShop() {
            const shopMenu = document.getElementById('shopMenu');
            shopMenu.style.display = shopMenu.style.display === 'block' ? 'none' : 'block';
            updateShop();
        }
        window.toggleShop = toggleShop; // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏

        function drawShop() {
            document.getElementById('shopGold').textContent = gold;
        }
        window.drawShop = drawShop;



        function updateGold(amount) {
    return new Promise((resolve, reject) => {
        console.log(`Updating gold: current gold = ${gold}, new gold = ${amount}`);
        gold = amount;
        document.getElementById('statusGold').textContent = gold;
        const playerGoldRef = ref(database, `players/${nickname}/gold`);
        set(playerGoldRef, gold).then(() => {
            console.log(`Gold updated in database: ${gold}`);
            resolve();
        }).catch((error) => {
            console.error('Error updating gold:', error);
            reject(error);
        });
    });
}


window.updateGold = updateGold;



async function endSession(nickname, sessionId) {
    const dbRef = ref(database, `players/${nickname}/session`);
    console.log(`–í endSession, nickname: ${nickname}, sessionid: ${sessionId}`);
    try {
        const result = await runTransaction(dbRef, (currentSession) => {
            if (currentSession === null) {
                console.log(`No session to end for ${nickname}.`);
                return null; // Ignore if there's no session
            }
            if (currentSession === sessionId) {
                console.log(`Ending session ${sessionId} for ${nickname}`);
                return null;
            } else {
                console.error(`Session mismatch during transaction: currentSession=${currentSession}, sessionId=${sessionId}`);
                throw new Error("Session mismatch");
            }
        });
        if (result.committed) {
            console.log(`Session ${sessionId} for ${nickname} ended successfully`);
            currentSessionId = null;
        } else {
            console.log(`Session ${sessionId} for ${nickname} was not ended`);
        }
    } catch (error) {
        console.error('Error ending session:', error);
    }
}
window.endSession = endSession;

function watchSessionChanges() {
    const dbRef = ref(database, `players/${nickname}/session`);
    onValue(dbRef, (snapshot) => {
        const sessionId = snapshot.val();
        if (sessionId !== currentSessionId && sessionId !== null) {
            console.log(`Session changed from ${currentSessionId} to ${sessionId}`);
            alert('–í—ã –±—ã–ª–∏ –≤—ã–±—Ä–æ—à–µ–Ω—ã –∏–∑ –∏–≥—Ä—ã, —Ç–∞–∫ –∫–∞–∫ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –Ω–∞—á–∞—Ç–∞ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–ª–∏ –≤–∫–ª–∞–¥–∫–∏.');
            endCurrentSession();
            location.reload();  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∏–≥—Ä—ã
        }
    });
}
window.watchSessionChanges = watchSessionChanges;

function generateSessionId() {
    return Math.random().toString(36).substr(2, 9);
}

function endCurrentSession() {
    if (nickname && currentSessionId) {
        endSession(nickname, currentSessionId);
    }
}
window.endCurrentSession = endCurrentSession;




function hideRebornPrompt() {
    document.getElementById('rebornPrompt').style.display = 'none';
}






window.showRebornPrompt = showRebornPrompt;
window.hideRebornPrompt = hideRebornPrompt;



function sendRewards() {
    const sortedPlayers = Object.entries(playersDamage).sort(([, damageA], [, damageB]) => damageB - damageA);
    const rewards = {
        top3: 10000,
        top10: 1000
    };

    sortedPlayers.forEach(([player, damage], index) => {
        let reward = 0;
        if (index < 3) {
            reward = rewards.top3;
        } else if (index < 10) {
            reward = rewards.top10;
        }
        if (reward > 0) {
            sendMail(player, reward, index + 1, damage);
            console.log(`Reward sent to player ${player}: ${reward} gold for rank ${index + 1} with damage ${damage}`);
        }
    });

    // –û–±–Ω—É–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞
    playersDamage = {};
    syncPlayersDamage();
}
window.sendRewards = sendRewards;


function sendMail(player, reward, rank, damage) {
    const mailMessage = `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∑–∞–Ω—è–ª–∏ ${rank}-–µ –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ —Å —É—Ä–æ–Ω–æ–º ${damage}. –í–∞—à–∞ –Ω–∞–≥—Ä–∞–¥–∞: ${reward} –∑–æ–ª–æ—Ç–∞.`;
    const playerMailRef = ref(database, `players/${player}/mail`);
    console.log(`Preparing to send mail to ${player}: ${mailMessage}`);
    get(playerMailRef).then((snapshot) => {
        let playerMail = snapshot.val() || {};
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –ø–∏—Å—å–º–∞
        const existingMail = Object.values(playerMail).find(mail => mail.message === mailMessage);
        if (existingMail) {
            console.log(`Mail already exists for player ${player}: ${mailMessage}`);
            return;
        }
        const mailId = `mail_${Date.now()}`;
        playerMail[mailId] = {
            reward: reward,
            message: mailMessage,
            timestamp: Date.now()
        };
        set(playerMailRef, playerMail).then(() => {
            console.log(`Mail sent to player ${player}: ${mailMessage}`);
        }).catch((error) => {
            console.error('Error setting mail data:', error);
        });
    }).catch((error) => {
        console.error('Error getting mail data:', error);
    });
}
window.sendMail = sendMail;





function loadMail() {
    const mailWindow = document.getElementById('mailWindow');
    mailWindow.innerHTML = '<h2>–í–∞—à–∞ –ø–æ—á—Ç–∞</h2><div id="mailContent"></div><button onclick="toggleMailWindow()">–ó–∞–∫—Ä—ã—Ç—å</button>';
    const mailContent = document.getElementById('mailContent');
    const playerMailRef = ref(database, `players/${nickname}/mail`);
    console.log(`Loading mail for player ${nickname}`);
    get(playerMailRef).then((snapshot) => {
        const mailsObject = snapshot.val() || {};
        console.log('Mails Object:', mailsObject);
        const mails = Object.entries(mailsObject); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ [–∫–ª—é—á, –∑–Ω–∞—á–µ–Ω–∏–µ]
        mails.forEach(([mailId, mail]) => {
            const mailItem = document.createElement('div');
            console.log('Mail Item:', mail);
            mailItem.innerHTML = `
                <p>${mail.message}</p>
                <p>–ù–∞–≥—Ä–∞–¥–∞: ${mail.reward} –∑–æ–ª–æ—Ç–∞</p>
                <button onclick="claimReward('${mailId}', ${mail.reward})">–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É</button>
            `;
            mailContent.appendChild(mailItem);
        });
    }).catch((error) => {
        console.error('Error loading mail:', error);
    });
}
window.loadMail = loadMail;

function claimReward(mailId, reward) {
    const playerMailRef = ref(database, `players/${nickname}/mail/${mailId}`);
    const playerGoldRef = ref(database, `players/${nickname}/gold`);

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–ª–æ—Ç–∞
    get(playerGoldRef).then((snapshot) => {
        let currentGold = snapshot.val() || 0;
        let newGold = currentGold + reward;
        updateGold(newGold);  // –ò—Å–ø–æ–ª—å–∑—É–µ–º updateGold

        // –£–¥–∞–ª—è–µ–º –ø–∏—Å—å–º–æ
        set(playerMailRef, null).then(() => {
            console.log(`Mail ${mailId} deleted`);

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—á—Ç—É
            loadMail();
            saveProgress(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            updateStatusBar(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–∞—Ä
        }).catch((error) => {
            console.error('Error deleting mail:', error);
        });
    }).catch((error) => {
        console.error('Error getting current gold:', error);
    });
}

window.claimReward = claimReward;



function spendGold(amount) {
    const playerGoldRef = ref(database, `players/${nickname}/gold`);

    get(playerGoldRef).then((snapshot) => {
        let currentGold = snapshot.val() || 0;
        if (currentGold >= amount) {
            updateGold(currentGold - amount); 

            set(playerGoldRef, currentGold - amount).then(() => { 
                console.log(`Gold spent: ${amount}, remaining gold: ${currentGold - amount}`);

                //  –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É  —Å—Ç—Ä–æ–∫—É üëá 
                gold = currentGold - amount;  

                document.getElementById('statusGold').textContent = gold; 
                saveProgress();
                updateStatusBar();
            }).catch((error) => {
                console.error('Error updating gold:', error);
            });
        } else {
            console.log('Not enough gold to spend.');
        }
    }).catch((error) => {
        console.error('Error getting current gold:', error);
    });
}
window.spendGold = spendGold;










function resetWorldBossHealth() {
    worldBossHealth = 1000000; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ –±–æ—Å—Å–∞
    syncWorldBossHealth(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    console.log("World Boss Health has been reset to 100%");
    updateWorldBossHealthDisplay(); // –û–±–Ω–æ–≤–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    drawWorldBossBattle(); // –ü–µ—Ä–µ—Ä–∏—Å—É–π—Ç–µ —ç–∫—Ä–∞–Ω –±–æ—è —Å –±–æ—Å—Å–æ–º
}
function getTimeUntilNextHour() {
    const now = new Date();
    const nextHour = new Date(now.getTime() + (60 - now.getMinutes()) * 60 * 1000);
    nextHour.setMinutes(0, 0, 0);
    return nextHour - now;
}
function startHourlyReset() {
    const timeUntilNextHour = getTimeUntilNextHour();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–±—Ä–æ—Å–∏—Ç –∑–¥–æ—Ä–æ–≤—å–µ –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞—Å–∞
    setTimeout(() => {
        resetWorldBossHealth();
        
        // –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –∑–¥–æ—Ä–æ–≤—å—è –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
        setInterval(resetWorldBossHealth, 3600000);
    }, timeUntilNextHour);
}




 

        function buyWeapon(type, power, cost) {
            if (gold >= cost) {
                weaponPower = power;
                updateGold(gold - cost);  // –ò—Å–ø–æ–ª—å–∑—É–µ–º updateGold
                weaponLevel = 1;
                if (type === 'sword') {
                    weaponName = '–ú–µ—á';
                    document.getElementById('characterImage').src = peasantWithSwordImage;
                }
                updateCharacterMenu();
                updateShop();
                saveProgress(nickname, {
                    currentLevel,
                    gold,
                    playerHealth,
                    weaponPower,
                    weaponName,
                    weaponLevel
                });
            }
        }

        window.buyWeapon = buyWeapon;

        function upgradeWeapon(type, costPerLevel) {
            if (gold >= costPerLevel && weaponName === '–ú–µ—á') {
                weaponPower += 15;
                updateGold(gold - costPerLevel);  // –ò—Å–ø–æ–ª—å–∑—É–µ–º updateGold
                weaponLevel++;
                updateCharacterMenu();
                updateShop();
                saveProgress(nickname, {
                    currentLevel,
                    gold,
                    playerHealth,
                    weaponPower,
                    weaponName,
                    weaponLevel
                });
            }
        }

        window.upgradeWeapon = upgradeWeapon;

        function continueGame() {
    document.getElementById('shopMenu').style.display = 'none';
    if (currentLevel < 10000) {
        currentLevel++;
        initializeMonster(baseMonsterHealth * Math.pow(1.1, currentLevel - 1));
        startLevel(currentLevel);
    } else {
        currentScreen = 'victory';
        drawVictoryScreen();
    }
    updateTopPlayers(nickname, { nickname, level: currentLevel });
    drawLevelMap();
}


        window.continueGame = continueGame;

        function getHealthColor(percentage) {
    let color;
    if (percentage > 50) {
        color = 'green';
    } else if (percentage > 20) {
        color = 'yellow';
    } else {
        color = 'red';
    }
   // console.log(`Health percentage: ${percentage}, Color: ${color}`);
    return color;
}

function updateMonsterHealthDisplay() {
    const healthBar = document.getElementById('monsterHealthBar');
    const healthValue = document.getElementById('monsterHealthValue');

    if (healthBar) {
        let currentHealth, maxHealth;
        
        // –í—ã–±–∏—Ä–∞–µ–º  –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ  –∑–¥–æ—Ä–æ–≤—å–µ  –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏  –æ—Ç  —ç–∫—Ä–∞–Ω–∞
        if (currentScreen === 'worldBoss') {
            currentHealth = worldBossHealth;
            maxHealth = 1000000;  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ  –∑–¥–æ—Ä–æ–≤—å–µ  –º–∏—Ä–æ–≤–æ–≥–æ –±–æ—Å—Å–∞
        } else {
            currentHealth = monsterHealth;
            maxHealth = 100 * Math.pow(1.1, currentLevel - 1); 
        }

        const healthPercentage = (currentHealth / maxHealth) * 100; 
        const color = getHealthColor(healthPercentage);
        healthBar.style.width = `${Math.min(healthPercentage, 100)}%`;
        healthBar.style.backgroundColor = color;
    }

    if (healthValue) {
        // –í—ã–±–∏—Ä–∞–µ–º  –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ  –∑–¥–æ—Ä–æ–≤—å–µ  –≤  –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏  –æ—Ç  —ç–∫—Ä–∞–Ω–∞
        if (currentScreen === 'worldBoss')  {
            healthValue.textContent =  worldBossHealth.toFixed(0);
        }  else {
            healthValue.textContent =  monsterHealth.toFixed(0); 
        }
    }
}
window.updateMonsterHealthDisplay =  updateMonsterHealthDisplay;

window.getHealthColor = getHealthColor;


function drawArena() {
    ctx.clearRect(0, 0, canvas.width, canvas.height); //  –û—á–∏—â–∞–µ–º  —Ö–æ–ª—Å—Ç
    ctx.drawImage(arena2, 0, 0, canvas.width, canvas.height);  //  –†–∏—Å—É–µ–º  –∞—Ä–µ–Ω—É 
    
}
window.drawArena  =  drawArena;

function switchChat(chat) {
    currentChat = chat; 
    const chatMessages = document.getElementById('chatMessages'); 
    chatMessages.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è 
    
    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞  —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π  —á–∞—Ç –≤  Firebase
    if (chat === 'global') {
        listenForGlobalMessages();
    } else  if (chat ===  'clan'  && currentClan) {
        listenForClanMessages(currentClan); 
    } else if (chat  === 'clan' && !currentClan) {
        displayChatMessage({ 
            nickname:  'System', 
            text:  '–í—ã  –Ω–µ  —Å–æ—Å—Ç–æ–∏—Ç–µ –≤  –∫–ª–∞–Ω–µ!'
        });
    }
}
window.switchChat = switchChat;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç–∞
function listenForGlobalMessages() {
    off(ref(database,  'chat/messages')); //  –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ  —Å–ª—É—à–∞—Ç–µ–ª–∏ 
    onValue(ref(database, 'chat/messages'), function(snapshot) {
        displayMessages(snapshot);
    }); 
}


//  –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è  —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∞–Ω–æ–≤–æ–≥–æ  —á–∞—Ç–∞
function listenForClanMessages(clanName) {
    off(ref(database,  'chat/messages')); //  –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ  —Å–ª—É—à–∞—Ç–µ–ª–∏
    const clanChatRef = ref(database,  `clans/${clanName}/chat`); 
    onValue(clanChatRef, function(snapshot) {
        displayMessages(snapshot);
    }); 
}

//  –§—É–Ω–∫—Ü–∏—è –¥–ª—è  –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è  —Å–æ–æ–±—â–µ–Ω–∏–π
function displayMessages(snapshot) {
    const chatMessages = document.getElementById('chatMessages'); 
    chatMessages.innerHTML = ''; 
    snapshot.forEach(function(childSnapshot) {
        const message = childSnapshot.val();
        const messageElement = document.createElement('div'); 
        messageElement.innerHTML = `<strong>${message.nickname}:</strong> ${message.text}`;
        chatMessages.appendChild(messageElement); 
    }); 
    chatMessages.scrollTop = chatMessages.scrollHeight; //  –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑  
}



async function updateClanMemberData(memberNickname, data) {
    if (currentClan && memberNickname in clans[currentClan].members) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∫–ª–∞–Ω–∞
        Object.assign(clans[currentClan].members[memberNickname], data);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∞–Ω–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        await set(ref(database, 'clans/' + currentClan), clans[currentClan]);
        console.log(`–î–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ${memberNickname} –≤ –∫–ª–∞–Ω–µ ${currentClan} –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`);
    }
}
window.updateClanMemberData = updateClanMemberData;


function calculateClanDamageBonus(clanLevel)  {
  return 10 * Math.pow(2,  clanLevel - 1); // 10  —É—Ä–æ–Ω–∞  –Ω–∞ 1  —É—Ä–æ–≤–Ω–µ,  —Ö5  –Ω–∞  –∫–∞–∂–¥–æ–º  —Å–ª–µ–¥—É—é—â–µ–º
}
window.calculateClanDamageBonus = calculateClanDamageBonus;

async  function  resetClanIfInvalid(nickname,  data) { //  –î–æ–±–∞–≤–ª—è–µ–º  data  –≤  –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–ª–∞–Ω–∞  –¥–ª—è  –∏–≥—Ä–æ–∫–∞", nickname);

    //  –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª –ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω currentClan  –≤–æ–æ–±—â–µ  
    if (data.currentClan) { 
        const clansSnapshot = await  get(ref(database, 'clans')); 
        if (clansSnapshot.exists()) {
            const clansData = clansSnapshot.val(); 
            let clanFound = false; 

            for (const  clanName in  clansData)  { 
                if (nickname  in clansData[clanName].members) {
                    console.log("–ö–ª–∞–Ω –Ω–∞–π–¥–µ–Ω, currentClan:",  currentClan);
                    clanFound = true;
                    break;
                } 
            } 

            //  –ï—Å–ª–∏ –∫–ª–∞–Ω –Ω–µ  –Ω–∞–π–¥–µ–Ω,  —Å–±—Ä–∞—Å—ã–≤–∞–µ–º  currentClan  
            if (!clanFound)  {
                console.log("–ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω,  —Å–±—Ä–∞—Å—ã–≤–∞–µ–º  currentClan");
                currentClan =  null;

                //  –û–±–Ω–æ–≤–ª—è–µ–º  –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞  –≤  –±–∞–∑–µ  –¥–∞–Ω–Ω—ã—Ö,  —á—Ç–æ–±—ã  —É–±—Ä–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π currentClan
                const playerProgressRef = ref(database,  `players/${nickname}/progress`); 
                await  set(playerProgressRef, {  ...(await get(playerProgressRef)).val(), currentClan: null }); 

                showGameMessage('–í—ã –±—ã–ª–∏  —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∫–ª–∞–Ω–∞, –ø–æ—Å–∫–æ–ª—å–∫—É  –æ–Ω  –±–æ–ª—å—à–µ  –Ω–µ  —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.'); 
            } 
        }
    }
}
window.resetClanIfInvalid = resetClanIfInvalid;

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–ª–∞–Ω–∞
function Clan(name, leader) {
    this.name = name;
    this.leader = leader;
    this.members = {}; // –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–ª–µ–Ω–æ–≤ –∫–ª–∞–Ω–∞ {nickname: {rank, level, damage}}
    this.level = 1;
    this.upgradeCost = 10000; // –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è
    this.members[leader] = { rank: 'leader', level: currentLevel, damage: calculateTotalDamage() }; // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–¥–µ—Ä–∞ –≤ –∫–ª–∞–Ω
    this.damageBonus = 10; 
}

// –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞–Ω–≥–∏ –≤ –∫–ª–∞–Ω–µ
const clanRanks = {
    leader: '–õ–∏–¥–µ—Ä',
    deputy: '–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å',
    member: '–í–æ–∏–Ω'
};

// –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∞–Ω–æ–≤
let clans = {};

async function createClan(clanName) {
    console.log('–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω:', clanName);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–ª–æ—Ç–∞
    if (gold < 1000) {
        showGameMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ  –∑–æ–ª–æ—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–Ω–∞!');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
    if (clanName in clans) {
        showGameMessage('–ö–ª–∞–Ω  —Å  —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º  —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –≤ –∫–ª–∞–Ω–µ
    if (await isPlayerInClan(nickname)) {
        showGameMessage('–í—ã  —É–∂–µ  —Å–æ—Å—Ç–æ–∏—Ç–µ  –≤  –∫–ª–∞–Ω–µ!');
        return;
    }

    console.log('–°–æ–∑–¥–∞–µ–º –∫–ª–∞–Ω:', clanName, '–¥–ª—è –ª–∏–¥–µ—Ä–∞:', nickname);
    spendGold(1000);
    clans[clanName] = new Clan(clanName, nickname);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∞–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    await set(ref(database, 'clans/' + clanName), clans[clanName]); 

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–æ–≤ 
    await updateClanList(); 

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentClan  —è–≤–Ω–æ
    currentClan = clanName; 

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–ª–∞–Ω–∞
    updateClanInterface(); 
    await isPlayerInClan(nickname); 

    console.log('–ö–ª–∞–Ω', clanName, '—É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
}
window.createClan = createClan;



async function openClanListMenu() {
    if (await isPlayerInClan(nickname)) {
        // –ò–≥—Ä–æ–∫ —É–∂–µ –≤ –∫–ª–∞–Ω–µ, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –∫–ª–∞–Ω–∞
        openClanMenu(); 
    } else {
        // –ò–≥—Ä–æ–∫ –Ω–µ –≤ –∫–ª–∞–Ω–µ, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Å–ø–∏—Å–∫–∞ –∫–ª–∞–Ω–æ–≤
        document.getElementById('clanListMenu').style.display = 'block';
        updateClanList();
    }
}
window.openClanListMenu = openClanListMenu;

function closeClanListMenu() {
    document.getElementById('clanListMenu').style.display = 'none';
}
window.closeClanListMenu = closeClanListMenu;

function openClanMenu() {
    document.getElementById('clanMenu').style.display = 'block';
    updateClanInterface();
}
window.openClanMenu = openClanMenu;

function closeClanMenu() {
    document.getElementById('clanMenu').style.display = 'none'; 
}
window.closeClanMenu = closeClanMenu; 

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–ª–∞–Ω–æ–≤
async function updateClanList() {
    const clanList = document.getElementById('clanList');
    clanList.innerHTML =  '';

    //  –°–æ—Ä—Ç–∏—Ä—É–µ–º  –∫–ª–∞–Ω—ã –ø–æ —É—Ä–æ–≤–Ω—é  (–≤ –ø–æ—Ä—è–¥–∫–µ  —É–±—ã–≤–∞–Ω–∏—è)
    const sortedClans = Object.entries(clans).sort(([, a], [, b]) =>  b.level - a.level); 

    for (const [clanName, clan] of sortedClans) {
        const clanItem =  document.createElement('li');
        
        //  –í—ã—á–∏—Å–ª—è–µ–º –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∫–ª–∞–Ω–∞  
        const  clanCapacity  =  clan.level  +  9;  
        
        clanItem.textContent = `${clan.name} (–£—Ä–æ–≤–µ–Ω—å:  ${clan.level}, –ò–≥—Ä–æ–∫–æ–≤:  ${Object.keys(clan.members).length}/${clanCapacity}, –õ–∏–¥–µ—Ä: ${clan.leader})`; // –î–æ–±–∞–≤–ª—è–µ–º –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å 
        clanItem.onclick = () =>  { joinClan(clanName);  };
        clanList.appendChild(clanItem);
    }
}


// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∞–Ω–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
function updateClanInterface() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞ –∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ –Ω–µ–º
    if (currentClan && nickname in clans[currentClan].members) {
        const clanNameElement = document.getElementById('clanName');
        const clanLevelElement = document.getElementById('clanLevel');
        const clanLeaderElement = document.getElementById('clanLeader');
        const clanMembersElement = document.getElementById('clanMembers');

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∞–Ω–µ
        clanNameElement.textContent = currentClan;
        clanLevelElement.textContent = clans[currentClan].level;
        clanLeaderElement.textContent = clans[currentClan].leader;

        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–ª–µ–Ω–æ–≤ –∫–ª–∞–Ω–∞
        clanMembersElement.innerHTML = '';

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º  –±–æ–Ω—É—Å  –∫  —É—Ä–æ–Ω—É
        const  damageBonusElement =  document.createElement('p');
        damageBonusElement.textContent =  `–ë–æ–Ω—É—Å  –∫ —É—Ä–æ–Ω—É: ${calculateClanDamageBonus(clans[currentClan].level)}`;
        clanMembersElement.appendChild(damageBonusElement);

        //  –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–≥–æ —á–ª–µ–Ω–∞  –∫–ª–∞–Ω–∞  –≤ —Å–ø–∏—Å–æ–∫
        for (const memberNickname in clans[currentClan].members) {
            const member = clans[currentClan].members[memberNickname];

            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º  –ª–∏–¥–µ—Ä–∞  –≤  —Ü–∏–∫–ª–µ, –µ—Å–ª–∏ —ç—Ç–æ  —Ç–µ–∫—É—â–∏–π  –∏–≥—Ä–æ–∫
            if (memberNickname ===  nickname  && member.rank  ===  'leader')  { 
                continue;
            }

            const memberItem = document.createElement('li');
            memberItem.textContent = `${memberNickname} (${clanRanks[member.rank]}, –£—Ä–æ–≤–µ–Ω—å: ${member.level}, –£—Ä–æ–Ω: ${member.damage})`;

            //  –ü—Ä–æ–≤–µ—Ä–∫–∞,  —è–≤–ª—è–µ—Ç—Å—è  –ª–∏ —Ç–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫  –ª–∏–¥–µ—Ä–æ–º  –∫–ª–∞–Ω–∞  
            if  (clans[currentClan].leader ===  nickname)  { 
                //  –î–æ–±–∞–≤–ª—è–µ–º  –∫–Ω–æ–ø–∫–∏  —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è  
                const appointDeputyButton = document.createElement('button'); 
                appointDeputyButton.textContent = '–ù–∞–∑–Ω–∞—á–∏—Ç—å  –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª–µ–º'; 
                appointDeputyButton.onclick =  ()  =>  {
                    const selectedMember =  prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –¥–ª—è  –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª–µ–º:');
                    if  (selectedMember)  { 
                        appointDeputy(selectedMember); 
                    }
                }; 
                memberItem.appendChild(appointDeputyButton); 

                const  kickMemberButton =  document.createElement('button'); 
                kickMemberButton.textContent = '–ò—Å–∫–ª—é—á–∏—Ç—å'; 
                kickMemberButton.onclick =  () =>  {
                    const  selectedMember = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º  —É—á–∞—Å—Ç–Ω–∏–∫–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è:'); 
                    if  (selectedMember)  {
                        kickMember(selectedMember);
                    }
                };
                memberItem.appendChild(kickMemberButton); 
            }
            //  –î–æ–±–∞–≤–ª–µ–Ω–∏–µ  –∫–Ω–æ–ø–∫–∏  –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –µ—Å–ª–∏  –∏–≥—Ä–æ–∫  -  –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å
            else  if (member.rank  === 'deputy'  &&  memberNickname  ===  nickname)  {
                const  kickMemberButton =  document.createElement('button'); 
                kickMemberButton.textContent =  '–ò—Å–∫–ª—é—á–∏—Ç—å';
                kickMemberButton.onclick =  ()  => {
                    const selectedMember = prompt('–í–≤–µ–¥–∏—Ç–µ  –Ω–∏–∫–Ω–µ–π–º  —É—á–∞—Å—Ç–Ω–∏–∫–∞  –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è:'); 
                    if (selectedMember)  { 
                        kickMember(selectedMember);
                    } 
                };
                memberItem.appendChild(kickMemberButton);
            }
            clanMembersElement.appendChild(memberItem);
        }
    } else {
        console.error('–ò–≥—Ä–æ–∫ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –∫–ª–∞–Ω–µ –∏–ª–∏ –∫–ª–∞–Ω –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
    }
}


// –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∏–≥—Ä–æ–∫ –≤ –∫–ª–∞–Ω–µ
async function isPlayerInClan(playerNickname) {
    console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞", playerNickname, "–≤ –∫–ª–∞–Ω–µ. –¢–µ–∫—É—â–∏–π –∫–ª–∞–Ω:", currentClan);
    const clansSnapshot = await get(ref(database, 'clans'));
    if (clansSnapshot.exists()) {
        const clansData = clansSnapshot.val();
        for (const clanName in clansData) {
            console.log('clansData[clanName]:', clansData[clanName]);
            if (playerNickname in clansData[clanName].members) {
                // –ò–≥—Ä–æ–∫ –Ω–∞–π–¥–µ–Ω –≤ –∫–ª–∞–Ω–µ
                currentClan = clanName;
                console.log("–ò–≥—Ä–æ–∫ –Ω–∞–π–¥–µ–Ω –≤ –∫–ª–∞–Ω–µ", currentClan);
                return currentClan;
            }
        }
    }
    console.log("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º –∫–ª–∞–Ω–µ");
    return currentClan; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º  currentClan (null, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω)
}




async function joinClan(clanName) {
    if (Object.keys(clans[clanName].members).length >= clans[clanName].level + 9) {
        showGameMessage('–ö–ª–∞–Ω —É–∂–µ –ø–æ–ª–æ–Ω!');
        return;
    }

    if (await isPlayerInClan(nickname)) {
        showGameMessage('–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ!');
        return;
    }
    clans[clanName].members[nickname] = { 
        rank: 'member', 
        level: currentLevel, 
        damage: calculateTotalDamage()
    };

    currentClan = clanName;
    await set(ref(database, 'clans/' + clanName), clans[clanName]); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∞–Ω–∞
    updateClanInterface();
    closeClanListMenu();
    openClanMenu();
    listenForClanMessages(currentClan);
}
window.joinClan = joinClan;


async function leaveClan() {
    if (currentClan && nickname in clans[currentClan].members) {
        if (clans[currentClan].members[nickname].rank === 'leader') {
            // –õ–∏–¥–µ—Ä –ø–æ–∫–∏–¥–∞–µ—Ç –∫–ª–∞–Ω

            // 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ª–∏–¥–µ—Ä–∞
            let newLeader = null;
            if (Object.keys(clans[currentClan].members).length > 1) {
                // –ï—Å—Ç—å –¥—Ä—É–≥–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏
                // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤–æ–≥–æ –ª–∏–¥–µ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ —É—Ä–æ–≤–Ω—é:
                newLeader = Object.entries(clans[currentClan].members)
                    .filter(([memberNickname, memberData]) => memberNickname !== nickname) // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ª–∏–¥–µ—Ä–∞
                    .reduce((max, [memberNickname, memberData]) => 
                        memberData.level > max[1].level ? [memberNickname, memberData] : max, ['', { level: 0 }])[0];

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–Ω–≥ –Ω–æ–≤–æ–≥–æ –ª–∏–¥–µ—Ä–∞
                clans[currentClan].members[newLeader].rank = 'leader';
                clans[currentClan].leader = newLeader;

                //  –°–æ—Ö—Ä–∞–Ω—è–µ–º  –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ  –¥–∞–Ω–Ω—ã–µ –∫–ª–∞–Ω–∞  
                await  set(ref(database, 'clans/' + currentClan), clans[currentClan]);
            }

            // 2. –£–≤–µ–¥–æ–º–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            if (newLeader) {
                showGameMessage(`–õ–∏–¥–µ—Ä –∫–ª–∞–Ω–∞ ${currentClan} –ø–æ–∫–∏–Ω—É–ª –∫–ª–∞–Ω. –ù–æ–≤—ã–º –ª–∏–¥–µ—Ä–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω ${newLeader}.`);
            } else {
                // –ù–µ—Ç –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —É–¥–∞–ª—è–µ–º –∫–ª–∞–Ω
                delete clans[currentClan];
                await remove(ref(database, 'clans/' + currentClan));
                showGameMessage(`–ö–ª–∞–Ω ${currentClan} —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.`);
            }

            // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ª–∏–¥–µ—Ä–∞ –∏–∑ –∫–ª–∞–Ω–∞
            delete clans[currentClan].members[nickname];
            currentClan = null; 

        } else {
            // –û–±—ã—á–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–¥–∞–µ—Ç –∫–ª–∞–Ω
            delete clans[currentClan].members[nickname];
            await set(ref(database, 'clans/' + currentClan), clans[currentClan]); 
            currentClan = null;
            showGameMessage(`–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–ª–∞–Ω ${currentClan}.`); 
        }

        //  –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è  –æ—Ç  —á–∞—Ç–∞  –∫–ª–∞–Ω–∞
        off(ref(database,  `clans/${currentClan}/chat`)); 

        //  –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞  –≥–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç
        switchChat('global'); 

        updateClanList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–æ–≤
        closeClanMenu();
    }
}
window.leaveClan = leaveClan; 

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π
function openClanDonateMenu() {
    const cost = clans[currentClan].upgradeCost;
    const donationsRef = ref(database, `clans/${currentClan}/donations`);
    get(donationsRef).then((snapshot) => {
        const currentDonations = snapshot.exists() ? snapshot.val() : 0; 
        document.getElementById('clanUpgradeCost').textContent = cost; 
        document.getElementById('clanCurrentDonations').textContent = currentDonations;
        document.getElementById('clanDonateMenu').style.display = 'block';
    }); 
}
window.openClanDonateMenu = openClanDonateMenu;

//  –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π 
function closeClanDonateMenu() {
    document.getElementById('clanDonateMenu').style.display = 'none'; 
}
window.closeClanDonateMenu = closeClanDonateMenu;

//  –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è –≤ –∫–ª–∞–Ω
async function donateToClan() {
    const donateAmount = Number(document.getElementById('clanDonateAmount').value);
    if (donateAmount > 0 && gold >= donateAmount) {
        spendGold(donateAmount);
        const clanDonationsRef = ref(database, `clans/${currentClan}/donations`);
        await runTransaction(clanDonationsRef, (current) => {
            return (current || 0) + donateAmount; 
        }); 
        document.getElementById('clanCurrentDonations').textContent = donateAmount; // –û–±–Ω–æ–≤–ª—è–µ–º  –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ 
        document.getElementById('clanDonateAmount').value =  '';  // –û—á–∏—â–∞–µ–º  –ø–æ–ª–µ  –≤–≤–æ–¥–∞
        showGameMessage('–°–ø–∞—Å–∏–±–æ  –∑–∞  –≤–∞—à–µ  –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ!');
    } else {
        showGameMessage('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è  —Å—É–º–º–∞  –∏–ª–∏  –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ  –∑–æ–ª–æ—Ç–∞!');
    }
}
window.donateToClan = donateToClan;

//  –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è upgradeClan
//  –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è upgradeClan
async function upgradeClan() {
    if (currentClan && nickname in clans[currentClan].members) {
        const currentLevel = clans[currentClan].level;
        const maxLevel = 10; 
        const cost = clans[currentClan].upgradeCost;
        const nextCapacity = currentLevel + 10; 

        if (currentLevel >= maxLevel) {
            showGameMessage(`–í–∞—à –∫–ª–∞–Ω —É–∂–µ –¥–æ—Å—Ç–∏–≥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è (${maxLevel}).`); 
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—É–º–º—É –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π 
        const clanDonationsRef = ref(database, `clans/${currentClan}/donations`);
        const donationsSnapshot = await get(clanDonationsRef); 
        let currentDonations = donationsSnapshot.exists() ? donationsSnapshot.val() : 0;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–µ—Ç –ª–∏ –ª–∏–¥–µ—Ä —É–ª—É—á—à–∏—Ç—å –∫–ª–∞–Ω
        if (clans[currentClan].members[nickname].rank === 'leader'  &&  currentDonations >= cost) { 
            if (confirm(`–£–ª—É—á—à–∏—Ç—å –∫–ª–∞–Ω –¥–æ —É—Ä–æ–≤–Ω—è ${currentLevel  +  1}?  \n` +
                        `–¢–µ–∫—É—â–∞—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${currentLevel  +  9} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n` +
                        `–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏—è:  ${nextCapacity} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`)) {
                // –í—ã—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è –∏–∑ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π
                currentDonations -= cost;

                // –û–±–Ω–æ–≤–ª—è–µ–º clans[currentClan].donations
                clans[currentClan].donations = currentDonations; 

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å—É–º–º—É –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π
                await set(clanDonationsRef, currentDonations);

                clans[currentClan].level++;
                clans[currentClan].upgradeCost *= 2; 
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å –∫ —É—Ä–æ–Ω—É 
                clans[currentClan].damageBonus = calculateClanDamageBonus(clans[currentClan].level);

                await set(ref(database, 'clans/' + currentClan), clans[currentClan]); 
                updateClanInterface(); 
            }
        } else  if (clans[currentClan].members[nickname].rank !== 'leader') {
            showGameMessage(`–¢–æ–ª—å–∫–æ –ª–∏–¥–µ—Ä –∫–ª–∞–Ω–∞ –º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å –∫–ª–∞–Ω!`)
        } else {
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è—Ö –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ 
            openClanDonateMenu();
        }
    }
}
window.upgradeClan = upgradeClan; 


async function appointDeputy(memberNickname) {
    if (currentClan && clans[currentClan].members[nickname].rank === 'leader') {
        if (memberNickname in clans[currentClan].members && memberNickname !== nickname) {
            clans[currentClan].members[memberNickname].rank = 'deputy';
            await set(ref(database, 'clans/' + currentClan), clans[currentClan]); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∞–Ω–∞
            updateClanInterface();
        } else {
            showGameMessage('–í—ã–±—Ä–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –∫–ª–∞–Ω–∞!');
        }
    }
}
window.appointDeputy = appointDeputy;

async function kickMember(memberNickname) {
    if (currentClan && 
       (clans[currentClan].members[nickname].rank === 'leader' || 
        clans[currentClan].members[nickname].rank === 'deputy')) {
        if (memberNickname in clans[currentClan].members && memberNickname !== nickname) {
            if (clans[currentClan].members[memberNickname].rank !== 'leader') {
                delete clans[currentClan].members[memberNickname];
                await set(ref(database, 'clans/' + currentClan), clans[currentClan]); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∞–Ω–∞
                updateClanInterface();
            } else {
                showGameMessage('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å –ª–∏–¥–µ—Ä–∞ –∫–ª–∞–Ω–∞!');
            }
        } else {
            showGameMessage('–í—ã–±—Ä–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –∫–ª–∞–Ω–∞!');
        }
    }
}
window.kickMember = kickMember;










































let turnTimeout; // –¢–∞–π–º-–∞—É—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö–æ–¥–∞–º–∏
let opponent; // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–µ
let totalDamage = 100; // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫–∞
let opponentDamage = 50; // –£—Ä–æ–Ω –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
let opponentHealth = 800; // –ó–¥–æ—Ä–æ–≤—å–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
let playerHealth = 800;
let currentPlayer = null;
let battleInProgress = false; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—è
let playerRef;
let opponentRef;
let onValueListener; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
let turnDuration = 3000; // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ö–æ–¥–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
let opponentListenerRef;
let isFinalizingBattle = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ 
let isListeningForOpponent = false; 
let battlePromise = null; // –ü—Ä–æ–º–∏—Å –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ listenForOpponent
let registrationPromise = null; // –ü—Ä–æ–º–∏—Å –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

// –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ PvP
function openPvpRegistration() {
    document.getElementById('pvpRegistration').style.display = 'block';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ PvP
function closePvpRegistration() {
    document.getElementById('pvpRegistration').style.display = 'none';
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ PvP
async function registerForPvp() {
  console.log("–ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ PvP. –¢–µ–∫—É—â–µ–µ –∑–¥–æ—Ä–æ–≤—å–µ: ", playerHealth);

  if (battleInProgress) {
    console.log("–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –±–æ—é!");
    return;
  }

  nickname = document.getElementById('nicknameInput').value;

  const inBattle = await isPlayerInBattle(nickname);
  if (inBattle) {
    console.log("–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –±–æ—é!");
    showGameMessage("–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –±–æ—é!");
    return;
  }

  // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
  console.log("–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...");
  await Promise.resolve(registrationPromise);
  console.log("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞.");

  playerHealth = 800;
  playerRef = ref(database, 'pvpQueue/' + nickname);
  console.log(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞ ${nickname} —Å –¥–∞–Ω–Ω—ã–º–∏: –∑–¥–æ—Ä–æ–≤—å–µ ${playerHealth}, —É—Ä–æ–Ω ${totalDamage}`);

  await set(playerRef, {
    nickname: nickname,
    health: playerHealth,
    damage: totalDamage,
    inBattle: false,
    timestamp: Date.now()
  });

  console.log(`${nickname} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ PvP —Å –¥–∞–Ω–Ω—ã–º–∏:`, {
    nickname: nickname,
    health: playerHealth,
    damage: totalDamage,
    timestamp: Date.now()
  });

  closePvpRegistration();
  showWaitingForOpponent();
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏ PvP
function listenForOpponent() {
  console.log("–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –±–æ—è...");

  Promise.resolve(battlePromise)
    .then(() => {
      console.log("–ü—Ä–µ–¥—ã–¥—É—â–∏–π –±–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω. –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏.");

      const opponentRef = ref(database, 'pvpQueue');
      opponentListenerRef = onValue(opponentRef, async (snapshot) => {
        if (snapshot.exists() && !battleInProgress && !isFinalizingBattle) {
          const queue = snapshot.val();
          const players = Object.entries(queue)
            .filter(([key, value]) => key && value && !value.inBattle && key !== nickname);
          console.log("–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏ PvP:", queue, "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∏:", players);

          if (players.length >= 1) {
            players.sort((a, b) => a[1].timestamp - b[1].timestamp);

            const player1 = [nickname, queue[nickname]];
            const player2 = players[0];

            if (player1[1] && player2[1]) {
              console.log("–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞—á–∞—Ç—å PvP –±–æ–π –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏:", player1, player2);

              // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ —Å–¥–∞—á–∏ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞
              const opponentSurrenderRef = ref(database, `pvpQueue/${player2[1].nickname}/surrender`);
              onValue(opponentSurrenderRef, (snapshot) => {
                if (snapshot.exists() && snapshot.val() === true) {
                  console.log("–û–ø–ø–æ–Ω–µ–Ω—Ç —Å–¥–∞–ª—Å—è!");
                  finalizePvpBattle('player', 'opponent_surrender');
                }
              });

              try {
                const startBattleSuccess = await startPvpBattle(player2[1]);
                if (startBattleSuccess) {
                  console.log("PvP –±–æ–π —É—Å–ø–µ—à–Ω–æ –Ω–∞—á–∞—Ç.");
                } else {
                  console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å PvP –±–æ–π. –í–æ–∑–º–æ–∂–Ω–æ, –¥—Ä—É–≥–æ–π –∏–≥—Ä–æ–∫ —É–∂–µ –Ω–∞—á–∞–ª –±–æ–π.");
                }
              } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –Ω–∞—á–∞—Ç—å PvP –±–æ–π:", error);
              }
            } else {
              console.log("–ù–µ –Ω–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ–ø–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –±–æ—è.");
            }
          }
        } else {
          console.log("–ò–¥–µ—Ç –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±–æ–π, –Ω–æ–≤—ã–µ –±–æ–∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è.");
        }
      });
    });
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–æ—è
async function finalizePvpBattle(winner, reason = null) {
  if (isFinalizingBattle) {
    console.log("–ë–∏—Ç–≤–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.");
    return;
  }

  isFinalizingBattle = true;

  if (!battleInProgress) {
    console.log("–ë–∏—Ç–≤–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
    isFinalizingBattle = false;
    return;
  }

  console.log(`–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–∏—Ç–≤—ã. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner}, –ü—Ä–∏—á–∏–Ω–∞: ${reason}`);
  battleInProgress = false;

  const opponentNickname = opponent ? opponent.nickname : null;

  try {
    // –ë–ª–æ–∫–∏—Ä—É–µ–º listenForOpponent –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    battlePromise = new Promise(resolve => {
      runTransaction(ref(database, 'pvpQueue'), (queue) => {
        if (!queue) {
          console.warn("–û—á–µ—Ä–µ–¥—å PvP –ø—É—Å—Ç–∞.");
          return undefined;
        }

        if (!queue[nickname] || (opponentNickname && !queue[opponentNickname])) {
          console.warn("–û–¥–∏–Ω –∏–∑ –∏–≥—Ä–æ–∫–æ–≤ —É–∂–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –æ—á–µ—Ä–µ–¥–∏.");
          return undefined;
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ inBattle –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
        queue[nickname].inBattle = false;
        queue[nickname].health = 800;
        if (opponentNickname) {
          queue[opponentNickname].inBattle = false;
          queue[opponentNickname].health = 800;
        }

        // –£–¥–∞–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        delete queue[nickname];
        if (opponentNickname) {
          delete queue[opponentNickname];
        }

        return queue;
      })
      .then(() => {
        console.log(`–ò–≥—Ä–æ–∫–∏ ${nickname} –∏ ${opponentNickname} —É–¥–∞–ª–µ–Ω—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏.`);
        resetBattleState();
        resolve(); // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–º–∏—Å –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', error);
        resolve(); // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–º–∏—Å, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
      });
    });

    // –î–æ–∂–∏–¥–∞–µ–º—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    await battlePromise;
    //  –ó–∞–ø–∏—Å—å  —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞  –±–∏—Ç–≤—ã  –≤  –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö  
    const  battlesRef =  ref(database,  'pvpBattles'); 
    const  newBattleRef  =  push(battlesRef);
     // –°–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∏–∫–Ω–µ–π–º—ã  –∏–≥—Ä–æ–∫–æ–≤  –≤  –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º  –ø–æ—Ä—è–¥–∫–µ
     const  players  =  [nickname,  opponentNickname].sort(); 
     await set(newBattleRef, {
            player1: players[0], //  –ù–∏–∫–Ω–µ–π–º  –ø–µ—Ä–≤–æ–≥–æ  –∏–≥—Ä–æ–∫–∞  (–≤  –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º  –ø–æ—Ä—è–¥–∫–µ) 
            player2: players[1],  // –ù–∏–∫–Ω–µ–π–º  –≤—Ç–æ—Ä–æ–≥–æ  –∏–≥—Ä–æ–∫–∞  (–≤  –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º  –ø–æ—Ä—è–¥–∫–µ) 
            winner: winner, 
            reason: reason,
            timestamp: Date.now() 
        });
    // –û–±–Ω–æ–≤–ª—è–µ–º UI (—Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è)
    if (winner === 'player') {
      if (reason === 'opponent_surrender') {
        document.getElementById('pvpFightLog').innerHTML += '<span style="color: green;">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ —Å–¥–∞–ª—Å—è! –í—ã –ø–æ–±–µ–¥–∏–ª–∏!</span><br>';
      } else {
        document.getElementById('pvpFightLog').innerHTML += '<span style="color: green;">–í—ã –ø–æ–±–µ–¥–∏–ª–∏!</span><br>';
      }
    } else if (winner === 'opponent') {
      if (reason === 'player_surrender') {
        document.getElementById('pvpFightLog').innerHTML += '<span style="color: red;">–í—ã —Å–¥–∞–ª–∏—Å—å! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!</span><br>';
      } else {
        document.getElementById('pvpFightLog').innerHTML += '<span style="color: red;">–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!</span><br>';
      }
    }
// –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Å–∫—Ä—ã—Ç–∏–µ–º pvpBattle
setTimeout(() => {
      document.getElementById('pvpBattle').style.display = 'none';
      const waitingMessage = document.getElementById('waitingMessage');
      if (waitingMessage) {
        document.body.removeChild(waitingMessage);
      }
    }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–µ—Ä–∂–∫–∏

    console.log("–î–∞–Ω–Ω—ã–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –±–æ—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.");
  

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –±–æ—è:', error);
  } finally {
    isFinalizingBattle = false;
    battlePromise = null; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º listenForOpponent
  }
}

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ PvP –±–æ—è
async function startPvpBattle(opponentData) {
  if (isFinalizingBattle) {
    console.log("–ü—Ä–µ–¥—ã–¥—É—â–∏–π –±–æ–π –µ—â–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤–æ–≥–æ –±–æ—è.");
    return false;
  }

  console.log("–ù–∞—á–∞–ª–æ –±–∏—Ç–≤—ã. –î–∞–Ω–Ω—ã–µ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞:", opponentData);

  if (battleInProgress) {
    console.log("–ë–∏—Ç–≤–∞ —É–∂–µ –∏–¥–µ—Ç. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–∞ startPvpBattle.");
    return false;
  }

  if (!opponentData || !opponentData.nickname || opponentData.health === undefined || opponentData.damage === undefined) {
    console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞:", opponentData);
    return false;
  }

  try {
    await runTransaction(ref(database, 'pvpQueue'), (queue) => {
      if (queue && 
          queue[nickname] && !queue[nickname].inBattle && 
          queue[opponentData.nickname] && !queue[opponentData.nickname].inBattle) {
        queue[nickname].inBattle = true;
        queue[opponentData.nickname].inBattle = true;
        return queue;
      } else {
        console.warn("–û–¥–∏–Ω –∏–∑ –∏–≥—Ä–æ–∫–æ–≤ —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –±–æ—é –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏.", queue);
        return undefined;
      }
    });

    battlePromise = new Promise(resolve => {
      stopListeningForOpponent();

      opponent = opponentData;
      opponentRef = ref(database, 'pvpQueue/' + opponent.nickname);
      opponentHealth = opponent.health;
      opponentDamage = opponent.damage;

      currentPlayer = (Math.random() > 0.5) ? 'player' : 'opponent';
      console.log("–ù–∞—á–∞–ª–æ –±–∏—Ç–≤—ã. –¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫:", currentPlayer);

      document.getElementById('pvpOpponentInfo').innerText = `–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: ${opponent.nickname}\n–ó–¥–æ—Ä–æ–≤—å–µ: ${opponent.health}\n–£—Ä–æ–Ω: ${opponent.damage}`;
      document.getElementById('pvpFightLog').innerHTML = '';
      document.getElementById('pvpBattle').style.display = 'block';

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º battleInProgress = true –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
      battleInProgress = true;

      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —Ö–æ–¥ 
      if (currentPlayer === 'player') {
        playerTurn();
      } else {
        opponentTurn();
      }

      // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤–æ –≤—Ä–µ–º—è –±–æ—è
      registrationPromise = battlePromise; 

      resolve();
    });

    return true;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–ª–∞–≥–æ–≤ inBattle:", error);
    return false;
  }
}

function stopListeningForOpponent() {
  if (opponentListenerRef) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º,  —á—Ç–æ —Å–ª—É—à–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω
    off(ref(database, 'pvpQueue'), opponentListenerRef);
    opponentListenerRef = null;
    console.log("–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ PvP –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");
  }
}


// –ü–æ–∫–∞–∑ –Ω–∞–¥–ø–∏—Å–∏ "–∏–¥–µ—Ç –ø–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞"
function showWaitingForOpponent() {
    const waitingMessage = document.createElement('div');
    waitingMessage.id = 'waitingMessage';
    waitingMessage.style.position = 'fixed';
    waitingMessage.style.top = '50%';
    waitingMessage.style.left = '50%';
    waitingMessage.style.transform = 'translate(-50%, -50%)';
    waitingMessage.style.background = 'rgba(0, 0, 0, 0.8)';
    waitingMessage.style.color = 'white';
    waitingMessage.style.padding = '20px';
    waitingMessage.style.borderRadius = '10px';
    waitingMessage.style.textAlign = 'center';
    waitingMessage.innerText = '–ò–¥–µ—Ç –ø–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
    document.body.appendChild(waitingMessage);
}









// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ PvP –±–æ—è –≤ —Ä—É—á–Ω—É—é –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π
function endPvpBattle() {
  if (!battleInProgress) {
    console.log("–ë–∏—Ç–≤–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
    return;
  }

  console.log("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–∏—Ç–≤—ã –≤—Ä—É—á–Ω—É—é.");

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–¥–∞—á–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  set(ref(database, `pvpQueue/${nickname}/surrender`), true);

  // –ó–∞–≤–µ—Ä—à–∞–µ–º –±–æ–π –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∏–≥—Ä–æ–∫–∞
  finalizePvpBattle('opponent', 'player_surrender'); 
}

function resetBattleState() {
    currentPlayer = null;
    playerRef = null;
    opponentRef = null;
    opponent = null;
    playerHealth = 800;
    opponentHealth = 800;
    battleInProgress = false;

    console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞. –ò–≥—Ä–æ–∫ –∑–¥–æ—Ä–æ–≤—å–µ: ", playerHealth, " –û–ø–ø–æ–Ω–µ–Ω—Ç –∑–¥–æ—Ä–æ–≤—å–µ: ", opponentHealth);
}

function playerTurn() {
    if (!battleInProgress) {
        console.log("–ë–∏—Ç–≤–∞ –Ω–µ –∏–¥–µ—Ç. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Ö–æ–¥–∞ –∏–≥—Ä–æ–∫–∞.");
        return;
    }
    console.log("–•–æ–¥ –∏–≥—Ä–æ–∫–∞. –£—Ä–æ–Ω:", totalDamage);
    opponentHealth -= totalDamage;
    if (opponentHealth < 0) opponentHealth = 0;
    console.log(`–£—Ä–æ–Ω –ø–æ –æ–ø–ø–æ–Ω–µ–Ω—Ç—É: ${totalDamage}. –ó–¥–æ—Ä–æ–≤—å–µ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞: ${opponentHealth}`);
    updateHealthBars(); // –û–±–Ω–æ–≤–∏—Ç—å health bar –ø—Ä–µ–∂–¥–µ, —á–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–∫–æ–Ω—á–∞–Ω–∏–µ –±–∏—Ç–≤—ã
    if (opponentHealth <= 0) {
        console.log("–û–ø–ø–æ–Ω–µ–Ω—Ç –ø–æ–±–µ–∂–¥–µ–Ω –∏–≥—Ä–æ–∫–æ–º.");
        finalizePvpBattle('player');
        return;
    }

    document.getElementById('pvpFightLog').innerHTML += `<span style="color: green;">–í—ã –Ω–∞–Ω–µ—Å–ª–∏ ${totalDamage} —É—Ä–æ–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É!</span><br>`;
    updateOpponentHealth();
    currentPlayer = 'opponent';
    console.log("–ü–µ—Ä–µ–¥–∞—á–∞ —Ö–æ–¥–∞ –æ–ø–ø–æ–Ω–µ–Ω—Ç—É.");
    scheduleNextTurn();
}

function opponentTurn() {
    if (!battleInProgress) {
        console.log("–ë–∏—Ç–≤–∞ –Ω–µ –∏–¥–µ—Ç. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Ö–æ–¥–∞ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞.");
        return;
    }
    console.log("–•–æ–¥ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞. –£—Ä–æ–Ω:", opponentDamage);
    playerHealth -= opponentDamage;
    if (playerHealth < 0) playerHealth = 0;
    console.log(`–£—Ä–æ–Ω –ø–æ –∏–≥—Ä–æ–∫—É: ${opponentDamage}. –ó–¥–æ—Ä–æ–≤—å–µ –∏–≥—Ä–æ–∫–∞: ${playerHealth}`);

    if (playerHealth <= 0) {
        console.log("–ò–≥—Ä–æ–∫ –ø–æ–±–µ–∂–¥–µ–Ω –æ–ø–ø–æ–Ω–µ–Ω—Ç–æ–º.");
        finalizePvpBattle('opponent');
        return;
    }

    document.getElementById('pvpFightLog').innerHTML += `<span style="color: red;">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å –≤–∞–º ${opponentDamage} —É—Ä–æ–Ω–∞!</span><br>`;
    updatePlayerHealth();
    currentPlayer = 'player';
    scheduleNextTurn();
}

async function updateOpponentHealth() {
    if (opponent && opponent.nickname) {
        const opponentHealthRef = ref(database, 'pvpQueue/' + opponent.nickname + '/health');
        await set(opponentHealthRef, opponentHealth)
            .then(() => {
                console.log(`–ó–¥–æ—Ä–æ–≤—å–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${opponentHealth}`);
            })
            .catch((error) => {
                console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞:`, error);
            });
    } else {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞.");
    }
}

async function updatePlayerHealth() {
    const playerHealthRef = ref(database, 'pvpQueue/' + nickname + '/health');
    await set(playerHealthRef, playerHealth)
        .then(() => {
            console.log(`–ó–¥–æ—Ä–æ–≤—å–µ –∏–≥—Ä–æ–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${playerHealth}`);
            
    updateHealthBars();

        })
        .catch((error) => {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–¥–æ—Ä–æ–≤—å—è –∏–≥—Ä–æ–∫–∞:`, error);
        });
}


function updateHealthBars() {
    const playerHealthPercentage = (playerHealth / 800) * 100; // 800 - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ
    document.getElementById('playerHealthBar').style.width = playerHealthPercentage + '%';

    // const opponentHealthPercentage = (opponentHealth / 800) * 100; // 800 - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ
    // document.getElementById('opponentHealthBar').style.width = opponentHealthPercentage + '%';
}




function scheduleNextTurn() {
    if (!battleInProgress) {
        console.log("–ë–∏—Ç–≤–∞ –Ω–µ –∏–¥–µ—Ç. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ scheduleNextTurn.");
        return;
    }

    if (currentPlayer === 'player') {
        setTimeout(playerTurn, turnDuration);
    } else {
        setTimeout(opponentTurn, turnDuration);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞ –±–æ—è —Å —Ü–≤–µ—Ç–æ–≤—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
function updateFightLog(message, color) {
    const logElement = document.getElementById('pvpFightLog');
    const newMessage = document.createElement('span');
    newMessage.style.color = color;
    newMessage.innerHTML = message + '<br>';
    logElement.appendChild(newMessage);
}







// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∏–≥—Ä–æ–∫ –≤ –±–æ—é
async function isPlayerInBattle(playerNickname) {
    const battleRef = ref(database, 'pvpQueue/' + playerNickname);
    try {
        const snapshot = await get(battleRef);
        if (snapshot.exists()) {
            const playerData = snapshot.val();
            const inBattle = playerData.inBattle;
            console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—è –∏–≥—Ä–æ–∫–∞ ${playerNickname}: ${inBattle}`);
            return inBattle;
        }
        console.log(`–ò–≥—Ä–æ–∫ ${playerNickname} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—á–µ—Ä–µ–¥–∏ PvP.`);
        return false;
    } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—è –∏–≥—Ä–æ–∫–∞ ${playerNickname}:`, error);
        return false;
    }
}


        window.openPvpRegistration = openPvpRegistration;
        window.closePvpRegistration = closePvpRegistration;
        window.endPvpBattle = endPvpBattle;
        window.stopListeningForOpponent = stopListeningForOpponent;


        window.updateHealthBars = updateHealthBars;

        // window.registerForPvp = registerForPvp;
        // window.showWaitingForOpponent = showWaitingForOpponent;
        // window.startPvpBattle = startPvpBattle;
        // window.scheduleNextTurn = scheduleNextTurn;
        // window.opponentTurn = opponentTurn;
        // window.playerTurn = playerTurn;
        // window.updateOpponentHealth = updateOpponentHealth;
        // window.updatePlayerHealth = updatePlayerHealth;
        // window.finalizePvpBattle = finalizePvpBattle;
        
        // window.isPlayerInBattle = isPlayerInBattle;
            // window.listenForOpponent = listenForOpponent;
//         function clearQueue() {
//     const queueRef = ref(database, 'pvpQueue');
//     set(queueRef, null)
//     .then(() => {
//         console.log('–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞.');
//     })
//     .catch((error) => {
//         console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –æ—á–µ—Ä–µ–¥–∏:', error);
//     });
// }
// window.clearQueue = clearQueue;






function hitMonster(event) {
    if (currentScreen !== 'battle') return;
    if (monsterHealth <= 0) return;

    const rect = canvas.getBoundingClientRect();
    const mouseX = event.clientX - rect.left;
    const mouseY = event.clientY - rect.top;
    const monsterX = canvas.width / 2 - monsterImage.width / 2;
    const monsterY = canvas.height / 2 - monsterImage.height / 2;

    if (
        mouseX >= monsterX &&
        mouseX <= monsterX + monsterImage.width &&
        mouseY >= monsterY &&
        mouseY <= monsterY + monsterImage.height
    ) {
        showHitAnimation();
        const totalDamage = calculateTotalDamage();
        monsterHealth -= totalDamage;
        if (monsterHealth < 0) {
            monsterHealth = 0;
        }
        hits += 1;
        updateMonsterHealthDisplay();

        if (monsterHealth <= 0) {
            let goldReward = Math.round(10 * currentLevel * rewardMultiplier); // –ò—Å–ø–æ–ª—å–∑—É–µ–º Math.round –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
            console.log(`Monster defeated. Awarding gold: ${goldReward}`);
            updateGold(gold + goldReward).then(() => {
                console.log(`Gold after defeating monster: ${gold}`);
                document.getElementById('goldAmount').textContent = goldReward;
                return saveProgress();
            }).then(() => {
                showVictoryMessage();
            }).catch(error => {
                console.error('Error updating gold and saving progress:', error);
            });
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ  –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö  –∑–∞–¥–∞–Ω–∏–π 
        dailyQuests.forEach(quest  => { 
            if (quest.description.includes('–£–±–∏—Ç—å')  &&  !quest.completed)  { 
                quest.progress++; 
                if (quest.progress >=  quest.goal)  {
                    quest.completed =  true; 
                    showGameMessage(`–ó–∞–¥–∞–Ω–∏–µ  "${quest.description}"  –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!`);  
                } 
            }
        });

        }
        updateCharacterImage();
    }
}





window.hitMonster = hitMonster;


// –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–Ω—Å—Ç—Ä–∞ —Å –±–∞–∑–æ–≤—ã–º –∑–¥–æ—Ä–æ–≤—å–µ–º
function initializeMonster(initialHealth) {
    monsterHealth = initialHealth;
    console.log('Initializing monster with health:', initialHealth);
    updateMonsterImage(currentLevel);
    updateMonsterHealthDisplay();
}

window.initializeMonster = initializeMonster;

const level = 5;
const baseHealth = 100; // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –±–∞–∑–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ
const calculatedHealth = baseHealth * Math.pow(1.1, level - 1);
console.log(`Calculated health for level ${level}: ${calculatedHealth}`);




// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã –ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã –Ω–∞–¥ –º–æ–Ω—Å—Ç—Ä–æ–º
function showContinuePrompt() {
    currentLevel++; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–≤–Ω—é
    console.log(`Proceeding to level ${currentLevel}`);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ baseMonsterHealth –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–æ–≤–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è –º–æ–Ω—Å—Ç—Ä–∞
    const newMonsterHealth = baseMonsterHealth * Math.pow(1.1, currentLevel - 1);
    console.log(`New monster health for level ${currentLevel}: ${newMonsterHealth}`);
    console.log(`Base monster health: ${baseMonsterHealth}`); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è
    monsterHealth = newMonsterHealth;

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞ –Ω–æ–≤–æ–º —É—Ä–æ–≤–Ω–µ
    console.log('Saving progress after proceeding to next level:', {
        currentLevel,
        gold,
        playerHealth,
        weaponPower,
        weaponName,
        weaponLevel,
        heroes,
        levels,
        monsterHealth // –î–æ–±–∞–≤–ª—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –º–æ–Ω—Å—Ç—Ä–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ –Ω–æ–≤–æ–º —É—Ä–æ–≤–Ω–µ
    saveProgress();

    initializeMonster(newMonsterHealth);
    drawMenu();
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–ª–∞–Ω–µ
        updateClanMemberData(nickname, {
        level: currentLevel, //  –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π  —É—Ä–æ–≤–µ–Ω—å 
        damage: calculateTotalDamage()
    });
}




window.showContinuePrompt = showContinuePrompt;

function resetMonsterState() {
    initializeMonster(baseMonsterHealth * Math.pow(1.1, currentLevel - 1));
    console.log(`Monster health reset to: ${monsterHealth}`);
}





function hideContinuePrompt() {
    document.getElementById('continuePrompt').style.display = 'none';
    document.getElementById('victoryImage').style.display = 'none';
    document.getElementById('goldEarned').style.display = 'none'; // –°–∫—Ä—ã—Ç—å —Ç–µ–∫—Å—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–æ–ª–æ—Ç–∞
}



function continueToNextLevel() {
    hideContinuePrompt();
    if (currentLevel < 10000) {
        currentLevel++;
        startLevel(currentLevel);
        updateCharacterImage(); // –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    } else {
        currentScreen = 'victory';
        drawVictoryScreen();
    }
    updateTopPlayers(nickname, { nickname, level: currentLevel });
    drawLevelMap();
}



window.continueToNextLevel = continueToNextLevel;




        function drawMenu() {
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
        }
        function drawCastle() {
            ctx.drawImage(castle, 0, 0, canvas.width, canvas.height);
            document.getElementById('mailButton').style.display = 'block'; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—á—Ç—ã

            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–Ω–æ–ø–∫–∏ –ø–æ—á—Ç—ã
            const mailButton = document.getElementById('mailButton');
            const rect = mailButton.getBoundingClientRect();
            console.log(`Mail button coordinates: (${rect.left}, ${rect.top})`);
            console.log(`Mail button size: ${rect.width}x${rect.height}`);
        }
        window.drawCastle = drawCastle;
        function arena() {
            ctx.drawImage(arena2, 0, 0, canvas.width, canvas.height);
        }

        function drawDungeonEntrance() {
           // ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            ctx.drawImage(dungeonGateImage,0, 0, canvas.width, canvas.height);
        }

        function drawVictoryScreen() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = '50px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–í—ã –ø–æ–±–µ–¥–∏–ª–∏!', canvas.width / 2, canvas.height / 2);
        }
        
        function showVictoryMessage() {
    console.log("Victory message displayed");

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–±–µ–¥–µ
    const victoryMessage = document.createElement('div');
    victoryMessage.id = 'victoryMessage';
    victoryMessage.style.position = 'absolute';
    victoryMessage.style.top = '50%';
    victoryMessage.style.left = '50%';
    victoryMessage.style.transform = 'translate(-50%, -50%)';
    victoryMessage.style.padding = '20px';
    victoryMessage.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    victoryMessage.style.color = 'white';
    victoryMessage.style.fontSize = '24px';
    victoryMessage.style.textAlign = 'center';
    document.body.appendChild(victoryMessage);

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ–±–µ–¥—ã
    const victoryImage = document.createElement('img');
    victoryImage.id = 'victoryImage';
    victoryImage.src = 'win2.png';
    victoryImage.alt = '–í—ã –ø–æ–±–µ–¥–∏–ª–∏';
    victoryImage.style.width = '400px';
    victoryImage.style.height = 'auto';
    victoryImage.onclick = () => {
        document.body.removeChild(victoryMessage);
        showContinuePrompt();
    };
    victoryMessage.appendChild(victoryImage);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∑–æ–ª–æ—Ç–∞
    const goldEarnedDiv = document.createElement('div');
    goldEarnedDiv.id = 'goldEarned';
    goldEarnedDiv.style.fontSize = '24px';
    goldEarnedDiv.style.color = 'gold';
    goldEarnedDiv.style.fontFamily = "'Comic Sans MS', cursive, sans-serif";
    goldEarnedDiv.textContent = `–ó–æ–ª–æ—Ç–æ: ${document.getElementById('goldAmount').textContent}`;
    victoryMessage.appendChild(goldEarnedDiv);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–±–µ–¥–µ
    const victoryText = document.createElement('p');
    victoryText.textContent = '–ü–æ–±–µ–¥–∞! –í—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–Ω–∏–∂–∞—Ç—å Shap –∏ —É–±–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞?';
    victoryMessage.appendChild(victoryText);

    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (document.body.contains(victoryMessage)) {
            document.body.removeChild(victoryMessage);
            showContinuePrompt();
        }
    }, 3000); // –í—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–±–µ–¥–µ
}

window.showVictoryMessage = showVictoryMessage;


function calculateStars() {
    // –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–≤–µ–∑–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –∑–¥–æ—Ä–æ–≤—å—è –∏–≥—Ä–æ–∫–∞ –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏
    if (playerHealth > 80) {
        return 3;
    } else if (playerHealth > 50) {
        return 2;
    } else {
        return 1;
    }
}

function startLevel(levelNumber) {
    currentLevel = levelNumber;
    monsterHealth = 100 * Math.pow(1.1, levelNumber - 1); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –º–æ–Ω—Å—Ç—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω—è
    console.log(`Starting level ${levelNumber}`);
    console.log(`Monster health set to: ${monsterHealth}`);
    document.getElementById('monsterHealthContainer').style.display = 'block'; // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–¥–æ—Ä–æ–≤—å—è –º–æ–Ω—Å—Ç—Ä–∞
    document.getElementById('monsterHealthBar').style.width = '100%'; // –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —É—Ä–æ–≤–Ω—è
    updateMonsterImage(levelNumber); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–Ω—Å—Ç—Ä–∞
    
    currentScreen = 'battle';
    drawBattle();
    updateMonsterHealthDisplay(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —É—Ä–æ–≤–Ω—è
    updateCharacterImage(); // –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    //showHealthBar();  //  –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–æ—Å–∫—É  –∑–¥–æ—Ä–æ–≤—å—è 
}

window.startLevel = startLevel;

function showHealthBar() {
    const healthContainer = document.getElementById('monsterHealthContainer');
    healthContainer.style.display = 'block';
}

window.showHealthBar = showHealthBar;





function completeLevel(levelNumber, stars) {
    if (levels[levelNumber - 1]) {
        levels[levelNumber - 1].completed = true;
        levels[levelNumber - 1].stars = stars;
        saveProgress(nickname, {
            currentLevel,
            gold,
            playerHealth,
            weaponPower,
            weaponName,
            weaponLevel,
            levels
        });
        drawLevelMap();
    }
    updateCharacterImage(); // –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
}
window.completeLevel = completeLevel;


// function drawLevelsScreen() {
//     ctx.clearRect(0, 0, canvas.width, canvas.height);
//     ctx.fillStyle = 'black';
//     ctx.fillRect(0, 0, canvas.width, canvas.height);

//     ctx.fillStyle = 'white';
//     ctx.font = '30px Arial';
//     ctx.textAlign = 'center';
//     ctx.fillText('–£—Ä–æ–≤–Ω–∏ –∏ –ó–≤–µ–∑–¥—ã', canvas.width / 2, 50);

//     levels.forEach((level, index) => {
//         const { x, y } = getLevelPosition(index);

//         ctx.fillStyle = level.completed ? 'gold' : 'silver';
//         ctx.beginPath();
//         ctx.arc(x, y, 25, 0, Math.PI * 2);
//         ctx.fill();

//         ctx.fillStyle = 'white';
//         ctx.font = '20px Arial';
//         ctx.fillText(level.number, x, y + 8);

//         drawStars(x - 30, y + 35, level.stars);
//     });
// }





        function drawLevelMap() {
            //console.log(levels);  // –í—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –≤ –∫–æ–Ω—Å–æ–ª—å
           // console.log('Drawing level map');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);

            levels.forEach((level, index) => {
                const { x, y } = getLevelPosition(index);

                ctx.fillStyle = level.completed ? 'gold' : 'silver';
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(level.number, x, y + 8);

                drawStars(x - 30, y + 35, level.stars);
            });
        }

        function getLevelPosition(index) {
            const perRow = 5;
            const spacing = 80;
            const offsetX = (canvas.width - perRow * spacing) / 2;
            const offsetY = 100;

            const x = offsetX + (index % perRow) * spacing;
            const y = offsetY + Math.floor(index / perRow) * spacing;
            return { x, y };
        }
        




        const updateInterval = 1000; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (1 —Å–µ–∫—É–Ω–¥–∞)

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
function startUpdating() {
    if (!isUpdating) {
        isUpdating = true;
        setInterval(() => {
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            updateWorldBossData();
        }, updateInterval);
    }
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±–æ—Å—Å–∞ –∏ –∏–≥—Ä–æ–∫–æ–≤
function updateWorldBossData() {
    const dbRef = ref(database);
    get(child(dbRef, 'worldBoss')).then((snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            worldBossHealth = data.health;
            playersDamage = data.playersDamage || {};
            if (currentScreen === 'worldBoss') {
                drawWorldBossBattle();
            }
        } else {
            console.log("No data available for world boss");
        }
    }).catch((error) => {
        console.error(error);
    });
}













        
        function drawWorldBossBattle() {
    //console.log('Drawing World Boss Battle');
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const worldBossImage = document.getElementById('worldBossImage');
    const bossX = canvas.width / 2 - worldBossImage.width / 2;
    const bossY = canvas.height / 2 - worldBossImage.height / 2;

    ctx.drawImage(worldBossImage, bossX, bossY);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–µ–∫—Å—Ç–∞ –≤—ã—à–µ –±–æ—Å—Å–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —ç–∫—Ä–∞–Ω–∞
    const healthTextY = bossY - 40 > 0 ? bossY - 40 : 40;


    // –†–∏—Å—É–µ–º –ø–æ–ª–æ—Å–∫—É –∑–¥–æ—Ä–æ–≤—å—è
    drawHealthBar(worldBossHealth, canvas.width - 210, 10, 200, 20, 'red');
    

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏–≥—Ä–æ–∫–æ–≤
    const playersListX = canvas.width - 350; // —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ 200 –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è
const playersListStartY = canvas.height - 700; // —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ 100 –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –Ω–∏–∑–∞ —ç–∫—Ä–∞–Ω–∞
    //const playersListStartY = canvas.height / 2 - (Object.keys(playersDamage).length * 15); // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø–æ —Ü–µ–Ω—Ç—Ä—É
    let playersListY = playersListStartY - (Object.keys(playersDamage).length * 15); // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø–æ —Ü–µ–Ω—Ç—Ä—É

    const lineHeight = 30; // –∑–∞–¥–∞–µ–º –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏

    ctx.textAlign = 'right';
    ctx.font = '26px Roboto';
    ctx.strokeStyle = 'black'; // —Ü–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏
    ctx.lineWidth = 4; // —à–∏—Ä–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏
    ctx.fillStyle = 'white'; // —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    ctx.strokeText('–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤:', playersListX, playersListY);
    ctx.fillText('–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤:', playersListX, playersListY);
    playersListY += lineHeight; // —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–∞ –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
 

    Object.entries(playersDamage).sort(([, damageA], [, damageB]) => damageB - damageA).forEach(([player, damage], index) => {
        playersListY += lineHeight; // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
        ctx.strokeText(`${index + 1}. ${player}: ${damage}`, playersListX, playersListY);
        ctx.fillText(`${index + 1}. ${player}: ${damage}`, playersListX, playersListY);
    });

    updateStatusBar();
    updateMonsterHealthDisplay();
}












function drawBattle() {
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (currentScreen === 'worldBoss') {
        ctx.drawImage(document.getElementById('worldBossImage'), canvas.width / 2 - document.getElementById('worldBossImage').width / 2, canvas.height / 2 - document.getElementById('worldBossImage').height / 2);
        drawHealthBar(worldBossHealth, canvas.width - 210, 10, 200, 20, 'red');
    } else {
        const mobWidth = 600;
        const mobHeight = 580;
        const x = (canvas.width / 2) - (mobWidth / 2);
        const y = (canvas.height / 2) - (mobHeight / 2);
        ctx.drawImage(monsterImage, x, y, mobWidth, mobHeight); // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–Ω—Å—Ç—Ä–∞

        drawHealthBar(monsterHealth, canvas.width - 210, 10, 200, 20, 'red');
    }

    
    updateStatusBar();
}




function drawHealthBar(health, x, y, width, height, color) {
    ctx.fillStyle = 'grey';
    ctx.fillRect(x, y, width, height);
    ctx.fillStyle = color;
    ctx.fillRect(x, y, width * (health / 1000000), height);  // –£—á–∏—Ç—ã–≤–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ –±–æ—Å—Å–∞ 1000000
}


        function updateShop() {
            document.getElementById('shopGold').textContent = gold;
        }



// –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã





function updateDamageList() {
    const damageList = document.getElementById('damageList');
    damageList.innerHTML = '';

    const sortedPlayers = Object.entries(playersDamage).sort(([, a], [, b]) => b - a);
    sortedPlayers.forEach(([player, damage]) => {
        const listItem = document.createElement('li');
        listItem.textContent = `${player}: ${damage} —É—Ä–æ–Ω–∞`;
        damageList.appendChild(listItem);
    });
}

function hitWorldBoss(playerName, damage) {
    if (worldBossHealth <= 0) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞—Ç—å —É—Ä–æ–Ω –ø–æ—Å–ª–µ —Å–º–µ—Ä—Ç–∏ –±–æ—Å—Å–∞

    if (!playersDamage[playerName]) {
        playersDamage[playerName] = 0;
    }
    playersDamage[playerName] += damage;
    worldBossHealth -= damage;
    if (worldBossHealth < 0) worldBossHealth = 0;
    updateWorldBossHealthDisplay();
    updateDamageList();
    syncWorldBossHealth();
    syncPlayersDamage();
    updateMonsterHealthDisplay(); //  –î–æ–±–∞–≤—å—Ç–µ  –≤—ã–∑–æ–≤  –∑–¥–µ—Å—å

    if (worldBossHealth <= 0) {
        // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–≥—Ä–∞–¥ –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ –±–æ—Å—Å–∞
        sendRewards();
    }
}



function updateWorldBossHealthDisplay() {
    //console.log(`Updating World Boss Health Display: ${worldBossHealth}`);
    document.getElementById('worldBossHealthValue').textContent = worldBossHealth;
}

function startBossBattle() {
    changeScreen('worldBoss');
    startUpdating(); // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ
}

function changeScreen(screen) {
    console.log(`Changing screen to: ${screen}`);
    currentScreen = screen;
    document.getElementById('shopMenu').style.display = 'none';
    //document.getElementById('statusBar').style.display = 'none';
    document.getElementById('monsterHealthDisplay').style.display = (screen === 'dungeon') ? 'block' : 'none';
    document.getElementById('crosshair').style.display = 'none';
    document.getElementById('mailButton').style.display = (screen === 'castle') ? 'block' : 'none';
    crosshair.style.display = (screen === 'battle' || screen === 'worldBoss') ? 'block' : 'none';
    document.getElementById('rebornButton').style.display = (screen === 'dungeon') ? 'block' : 'none'; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ "battle"
    document.getElementById('pvpButton').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.getElementById('pvpLastBattles').style.display  =  'none';
    document.getElementById('dailyQuestsMenu').style.display  = 'none'; //  –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é  –∫–≤–µ—Å—Ç–æ–≤ 
    // Hide the monster health bar when changing screens
    if (screen !== 'dungeon' && screen !== 'battle') {  
        document.getElementById('monsterHealthContainer').style.display = 'none';
        updateStatusBar();
    }
    if (screen === 'worldBoss') {
        document.getElementById('worldBossScreen').style.display = 'block';
        document.getElementById('statusBar').style.display = 'block';
        updateStatusBar();
        drawWorldBossBattle();
        showWorldBossHealthBar();
    } else {
        document.getElementById('worldBossScreen').style.display = 'none';
    }

    if (screen === 'raid') {
        drawMenu();
    } else if (screen === 'dungeon') {
        showHealthBar(); // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–æ—Å–∫—É –∑–¥–æ—Ä–æ–≤—å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ dungeon
        drawDungeonEntrance();
        document.getElementById('statusBar').style.display = 'block';
        //updateStatusBar();
    } else if (screen === 'arena') {
        drawArena(); 
        displayLastPvpBattles();  //  –û—Ç–æ–±—Ä–∞–∂–∞–µ–º  –ø–æ—Å–ª–µ–¥–Ω–∏–µ  –±–∏—Ç–≤—ã  
        document.getElementById('pvpLastBattles').style.display  =  'block'; 
        document.getElementById('pvpButton').style.display  =  'block'; 
        arena();
        
        
    } else if (screen === 'castle') {
        drawCastle();
    } else if (screen === 'shop') {
        drawShop();
    } else if (screen === 'battle') {
        loadProgress(nickname).then(data => {
            console.log('Data after loading progress:', data);
            if (data) {
                currentLevel = data.currentLevel;
                gold = data.gold;
                playerHealth = data.playerHealth;
                weaponPower = data.weaponPower;
                weaponName = data.weaponName;
                weaponLevel = data.weaponLevel;
                levels = data.levels || levels;
                updateCharacterMenu();
            }
            document.getElementById('statusBar').style.display = 'block';
            updateStatusBar();
            startLevel(currentLevel); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π –±–æ—è
        });
    } else if (screen === 'levels') {
        // drawLevelsScreen();
    }
}

window.changeScreen = changeScreen;

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
document.getElementById('bottomMenu').querySelector('div').addEventListener('click', function() {
    changeScreen('arena');
});

function showWorldBossHealthBar() {
    const healthContainer =  document.getElementById('monsterHealthContainer'); 
    if (currentScreen === 'worldBoss') { //  –û—Ç–æ–±—Ä–∞–∂–∞–µ–º  –ø–æ–ª–æ—Å–∫—É  —Ç–æ–ª—å–∫–æ  –Ω–∞  —ç–∫—Ä–∞–Ω–µ  –±–æ—Å—Å–∞  
        healthContainer.style.display  =  'block'; 
    } else {
        healthContainer.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞  –¥—Ä—É–≥–∏—Ö  —ç–∫—Ä–∞–Ω–∞—Ö 
    }
}
window.showWorldBossHealthBar = showWorldBossHealthBar; 

function syncWorldBossHealth() {
    set(ref(database, 'worldBoss/health'), worldBossHealth);
}

function syncPlayersDamage() {
    set(ref(database, 'worldBoss/playersDamage'), playersDamage);
}

function loadWorldBossData() {
    const dbRef = ref(database);
    return get(child(dbRef, 'worldBoss')).then((snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            worldBossHealth = data.health;
            playersDamage = data.playersDamage || {};
            //console.log(`Loaded World Boss Health: ${worldBossHealth}`);
            updateWorldBossHealthDisplay();
            updateDamageList();
        } else {
            console.log("No data available for world boss");
        }
    }).catch((error) => {
        console.error(error);
    });
}
       


function updateCharacterMenu() {
    playerHealth = calculateTotalHealth(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è –∏–≥—Ä–æ–∫–∞
    document.getElementById('weapon').textContent = weaponName;
    document.getElementById('health').textContent = playerHealth;
    document.getElementById('damage').textContent = calculateTotalDamage();
    document.getElementById('gold').textContent = gold;
    document.getElementById('level').textContent = currentLevel;

    // –°–º–µ–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è –≤—ã—à–µ 10
    updateCharacterImage(); // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

    updateStatusBar(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å –±–∞—Ä–∞
}
window.updateCharacterMenu = updateCharacterMenu;


function calculateTotalDamage() {
    let totalDamage = 0;
    heroes.forEach(hero => {
        if (hero.hired) {
            totalDamage += hero.damage;
        }
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ  –∫–ª–∞–Ω–∞ –ø–µ—Ä–µ–¥  –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º  –±–æ–Ω—É—Å–∞ 
    if (currentClan && clans[currentClan]) {
        totalDamage += calculateClanDamageBonus(clans[currentClan].level);
    }
    return totalDamage;
}

window.calculateTotalDamage = calculateTotalDamage;

function calculateTotalHealth() {
    let totalHealth = 100; // –±–∞–∑–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ

    return totalHealth;
}
window.calculateTotalHealth = calculateTotalHealth;

let localGoldUpdated = false;

function updateStatusBar() {
    //console.log('updateStatusBar called'); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏

    if (!localGoldUpdated) {
        const playerGoldRef = ref(database, `players/${nickname}/gold`);
        get(playerGoldRef).then((snapshot) => {
            const goldAmount = snapshot.val() || 0;
           // console.log(`Gold amount retrieved from database: ${goldAmount}`); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

            document.getElementById('statusGold').textContent = goldAmount;
            gold = goldAmount; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∑–æ–ª–æ—Ç–∞
          //  console.log(`Global gold variable updated: ${gold}`); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

        }).catch((error) => {
            console.error('Error getting gold:', error);
        });
    } else {
        localGoldUpdated = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    }

    document.getElementById('statusLevel').textContent = currentLevel;
    document.getElementById('playerHealthBar').style.width = playerHealth + '%'; // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –ø–æ–ª–æ—Å—ã –∑–¥–æ—Ä–æ–≤—å—è
    document.getElementById('statusDamage').textContent = calculateTotalDamage(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —É—Ä–æ–Ω–∞
    document.getElementById('statusRewardMultiplier').textContent = rewardMultiplier.toFixed(1); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è –Ω–∞–≥—Ä–∞–¥—ã

    //console.log('Status bar updated'); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å –±–∞—Ä–∞
}
window.updateStatusBar = updateStatusBar;







        function toggleTopPlayers() {
    const menu = document.getElementById('topPlayersMenu');
    if (menu.style.display === 'block') {
        menu.style.display = 'none';
    } else {
        displayTopPlayers().then(topPlayers => {
            let topListHTML = '<h2>–¢–æ–ø –∏–≥—Ä–æ–∫–∏</h2>';
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é
            const sortedPlayers = Object.values(topPlayers).sort((a, b) => b.level - a.level);
            sortedPlayers.forEach(player => {
                topListHTML += `<p>${player.nickname} - –£—Ä–æ–≤–µ–Ω—å ${player.level}</p>`;
            });
            document.getElementById('topPlayersMenu').innerHTML = topListHTML;
            menu.style.display = 'block';
        });
    }
}


        window.toggleTopPlayers = toggleTopPlayers;



        canvas.addEventListener('click', function(event) {
    const rect = canvas.getBoundingClientRect();
    const mouseX = event.clientX - rect.left;
    const mouseY = event.clientY - rect.top;

    if (currentScreen === 'menu') {
        currentScreen = 'dungeon';
        drawDungeonEntrance();
    } else if (currentScreen === 'dungeon') {
        const gateCenterX = canvas.width / 2;
        const gateCenterY = canvas.height / 2;
        if (mouseX > gateCenterX - dungeonGateImage.width / 2 &&
            mouseX < gateCenterX + dungeonGateImage.width / 2 &&
            mouseY > gateCenterY - dungeonGateImage.height / 2) {
            currentScreen = 'battle';
            drawBattle();
            crosshair.style.display = 'block';
        } else {
            levels.forEach((level, index) => {
                const { x, y } = getLevelPosition(index);
                const radius = 25;

                if (Math.sqrt((mouseX - x) ** 2 + (mouseY - y) ** 2) < radius) {
                    if (levels[index].completed || index === currentLevel - 1) {
                        startLevel(level.number);
                    }
                }
            });
        }
    } else if (currentScreen === 'battle') {
        hitMonster(event);
    } else if (currentScreen === 'worldBoss') {
        console.log('Click detected on World Boss screen.');
        hitWorldBoss(nickname, calculateTotalDamage());
        syncWorldBossHealth();
        syncPlayersDamage();
    }
});


       
        function gameLoop() {
            requestAnimationFrame(gameLoop);
            if (currentScreen === 'menu') {
                drawMenu();
            } else if (currentScreen === 'dungeon') {
                drawDungeonEntrance();
            } else if (currentScreen === 'battle') {
                drawBattle();
            } else if (currentScreen === 'levelMap') {
                drawLevelMap();
            } else if (currentScreen === 'victory') {
                drawVictoryScreen();
            } else if (currentScreen === 'shop') {
                drawShop();
            }
        }

        window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    if (currentScreen === 'battle') {
        drawBattle(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —ç–∫—Ä–∞–Ω–∞ –±–æ—è
    } else if (currentScreen === 'arena') {
        drawArena(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∞—Ä–µ–Ω—ã
    } else if (currentScreen === 'castle') {
        drawCastle(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∞—Ä–µ–Ω—ã
    } else if (currentScreen === 'raid') {
        drawMenu(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∞—Ä–µ–Ω—ã
    } else if (currentScreen === 'menu') {
        drawMenu(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –º–µ–Ω—é
    } else if (currentScreen === 'dungeon') {
        drawDungeonEntrance(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–¥–∑–µ–º–µ–ª—å—è
    } else if (currentScreen === 'worldBoss') {
        drawWorldBossBattle(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –±–æ—è —Å –º–∏—Ä–æ–≤—ã–º –±–æ—Å—Å–æ–º
    }
});



        gameLoop();


        window.onload = async function() {  //  –î–æ–±–∞–≤—å—Ç–µ  async  
    console.log("Page loaded,  initializing  game."); 
    addHeroesToMenu(); 
    loadWorldBossData(); 
    gameLoop();
    changeScreen('menu'); 
    startUpdating(); 
    startHourlyReset(); 
    updateMonsterHealthDisplay(); 
    // –î–æ–±–∞–≤—å—Ç–µ await  –ø–µ—Ä–µ–¥  updateClanList  
    await updateClanList(); 
    // –ó–∞–ø—É—Å–∫–∞–µ–º  —Ç–∞–π–º–µ—Ä –¥–ª—è  –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ  —Å–±—Ä–æ—Å–∞  –∑–∞–¥–∞–Ω–∏–π  
    setInterval(resetDailyQuests,  1000  *  60  *  60 *  24);  //  –í—ã–∑—ã–≤–∞–µ–º  –∫–∞–∂–¥—ã–µ  24  —á–∞—Å–∞  
};

// function clearrQueue() {
//     const queueRef = ref(database, 'pvpQueue');
//     set(queueRef, null)
//     .then(() => {
//         console.log('–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞.');
//     })
//     .catch((error) => {
//         console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –æ—á–µ—Ä–µ–¥–∏:', error);
//     });
// }
// window.clearQueue = clearQueue;



// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è  sendMessage 
function sendMessage() {
    const chatMessageInput = document.getElementById('chatMessageInput'); 
    const message = chatMessageInput.value.trim();

    if (message  &&  nickname) { 
        const messageData = {
            text: message,
            timestamp: new Date().toISOString(), 
            nickname: nickname 
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º  —Å–æ–æ–±—â–µ–Ω–∏–µ  –≤  —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
        if (currentChat ===  'global') { 
            const newMessageRef = push(ref(database,  'chat/messages')); 
            set(newMessageRef, messageData); 
        } else if (currentChat  ===  'clan' && currentClan) { 
            const newMessageRef = push(ref(database,  `clans/${currentClan}/chat`)); 
            set(newMessageRef, messageData); 
        } else { 
        displayChatMessage({ 
            nickname:  'System',
            text:  '–í—ã  –Ω–µ  —Å–æ—Å—Ç–æ–∏—Ç–µ –≤  –∫–ª–∞–Ω–µ!'  
        }); 
        return;
        }

        chatMessageInput.value = ''; 
    } else  if  (!nickname) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞,  –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º, –ø—Ä–µ–∂–¥–µ —á–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.');
    }
}
window.sendMessage = sendMessage;

// –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ Enter
document.getElementById('chatMessageInput').addEventListener('keypress',  function(event) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞  —Ñ–æ–∫—É—Å–∞
    if (event.key === 'Enter'  &&  document.activeElement === this) { 
        sendMessage(); 
    } 
});


// –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
const chatMessages = document.getElementById('chatMessages');
onValue(ref(database, 'chat/messages'), function(snapshot) {
    chatMessages.innerHTML = '';
    snapshot.forEach(function(childSnapshot) {
        const message = childSnapshot.val();
        const messageElement = document.createElement('div');
        messageElement.innerHTML = `<strong>${message.nickname}:</strong> ${message.text}`;
        chatMessages.appendChild(messageElement);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
});

//  –§—É–Ω–∫—Ü–∏—è  –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è  —Å–æ–æ–±—â–µ–Ω–∏—è  –≤ —á–∞—Ç  
function displayChatMessage(message) {
    const  chatMessages  = document.getElementById('chatMessages');
    const  messageElement  = document.createElement('div'); 
    messageElement.innerHTML =  `<strong>${message.nickname}:</strong>  ${message.text}`;
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight; //  –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
}


// –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É PvP
const pvpButton = document.getElementById('pvpButton');
pvpButton.addEventListener('click', openPvpRegistration); 

// –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É "–î–∞" –≤ –æ–∫–Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
const pvpRegistrationButton = document.querySelector('#pvpRegistration button:first-of-type'); // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∫–Ω–æ–ø–∫—É

// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è "click"
pvpRegistrationButton.addEventListener('click', registerForPvp); 



    </script>
</body>
</html>